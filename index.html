<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherigram</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        :root {
            --accent-color: #667eea;
            --accent-dark: #5568d3;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-chat: #fafafa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --message-sent: #667eea;
            --message-received: #ffffff;
        }

        body.dark {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-chat: #0e0e0e;
            --text-primary: #e0e0e0;
            --text-secondary: #999999;
            --border-color: #3d3d3d;
            --message-sent: var(--accent-color);
            --message-received: #2d2d2d;
        }

        body.accent-blue {
            --accent-color: #2196F3;
            --accent-dark: #1976D2;
        }

        body.accent-green {
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
        }

        body.accent-grey {
            --accent-color: #607D8B;
            --accent-dark: #455A64;
        }

        body.accent-purple {
            --accent-color: #667eea;
            --accent-dark: #5568d3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-dark) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            max-height: 800px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            position: relative;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            body {
                background: var(--bg-primary);
            }
            .container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.success { border-left: 4px solid #4caf50; }
        .toast.error { border-left: 4px solid #f44336; }
        .toast.info { border-left: 4px solid var(--accent-color); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease;
        }

        /* Push Notifications */
        .push-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 10001;
            animation: slideInDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 320px;
            border-left: 4px solid var(--accent-color);
            cursor: pointer;
            transform-origin: top right;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .push-notification.hiding {
            animation: slideOutUp 0.3s ease;
        }

        @keyframes slideOutUp {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .notification-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .notification-sender {
            font-weight: 600;
            font-size: 15px;
        }

        .notification-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Auth Screen */
        .auth-screen {
            width: 100%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-screen h1 {
            color: var(--accent-color);
            margin-bottom: 30px;
            font-size: 36px;
        }

        .auth-form {
            width: 100%;
            max-width: 350px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: var(--accent-dark);
        }

        .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        .info-text {
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 14px;
            text-align: center;
        }

        /* Messenger */
        .messenger {
            display: none;
            width: 100%;
            position: relative;
        }

        /* Sidebar Menu */
        .sidebar-menu {
            position: absolute;
            left: -300px;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-primary);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-menu.open {
            left: 0;
        }

        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .menu-overlay.show {
            display: block;
        }

        .menu-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
        }

        .menu-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .menu-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
        }

        .menu-user-details h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .menu-user-details p {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-items {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
            color: var(--text-primary);
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item-icon {
            font-size: 24px;
            width: 24px;
        }

        .menu-section {
            padding: 16px 20px 8px 20px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar.mobile-hide {
                transform: translateX(-100%);
            }
            .chat-area {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                z-index: 2;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .chat-area.mobile-show {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 15px 20px;
            background: var(--accent-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .sidebar-header h2 {
            font-size: 20px;
        }

        .search-box {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .add-contact-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-primary);
        }

        .contact-item:active {
            transform: scale(0.98);
        }

        .contact-item:hover {
            background: var(--bg-secondary);
        }

        .contact-item.active {
            background: var(--bg-secondary);
        }

        .contact-item.favorite {
            background: linear-gradient(90deg, var(--bg-primary) 0%, rgba(255,215,0,0.1) 100%);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
            position: relative;
        }

        .favorite-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: gold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .contact-last-msg {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            animation: slideInFromTop 0.3s ease;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header:hover {
            background: var(--bg-secondary);
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: var(--text-primary);
            transition: transform 0.2s;
        }

        .back-btn:active {
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            .back-btn {
                display: block;
            }
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-info h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .chat-header-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-chat);
        }

        .empty-chat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            position: relative;
        }

        .message.sending {
            opacity: 0.7;
        }

        .message.new-message {
            animation: messageSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes messageSlideIn {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            50% {
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            background: var(--message-received);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .message.sent .message-content {
            background: var(--message-sent);
            color: white;
        }

        .message-text {
            word-wrap: break-word;
            color: inherit;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .message.sent .message-footer {
            color: rgba(255,255,255,0.8);
            justify-content: flex-end;
        }

        .message-status {
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .message-status.sending {
            animation: clockSpin 1.5s infinite linear;
        }

        @keyframes clockSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            display: none;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        /* Message Context Menu */
        .message-context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            min-width: 200px;
            padding: 8px 0;
        }

        .message-context-menu.show {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            max-width: 90vw;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            transition: background 0.2s;
            min-width: 80px;
            text-align: center;
        }

        .context-menu-item:hover {
            background: var(--bg-secondary);
        }

        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .context-menu-item.delete {
            color: #f44336;
        }

        .context-menu-icon {
            font-size: 24px;
            width: 100%;
        }

        .context-menu-label {
            font-size: 12px;
            white-space: nowrap;
        }

        /* Reply Preview */
        .reply-preview {
            display: none;
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-color);
            margin: 0 20px 10px 20px;
            border-radius: 4px;
            position: relative;
        }

        .reply-preview.show {
            display: block;
            animation: slideInFromBottom 0.3s ease;
        }

        .reply-preview-header {
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .reply-preview-text {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-preview-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .message-reply {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-color);
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .message-reply-header {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 2px;
        }

        .message-reply-text {
            color: var(--text-secondary);
        }

        .delete-btn {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .message.sent .delete-btn {
            background: rgba(255,255,255,0.3);
        }

        /* Chat Input - FIXED FOR MOBILE */
        .chat-input {
            padding: 15px 20px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInFromBottom 0.3s ease;
            position: sticky;
            bottom: 0;
            z-index: 100;
            /* Fix for mobile */
            box-sizing: border-box;
            width: 100%;
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attach-btn, .voice-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .attach-btn:active, .voice-btn:active {
            transform: scale(0.9);
        }

        .attach-btn:hover, .voice-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            font-size: 15px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            /* Fix for mobile */
            min-height: 40px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            border-color: var(--accent-color);
            background: var(--bg-primary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:active {
            transform: scale(0.9);
        }

        .send-btn:hover {
            background: var(--accent-dark);
            transform: scale(1.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        /* Theme Selection */
        .theme-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: rgba(var(--accent-color), 0.1);
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .theme-preview.light {
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }

        .theme-preview.dark {
            background: #1e1e1e;
            color: white;
        }

        .accent-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .accent-preview.blue { background: #2196F3; }
        .accent-preview.green { background: #4CAF50; }
        .accent-preview.grey { background: #607D8B; }
        .accent-preview.purple { background: #667eea; }

        .theme-info {
            flex: 1;
        }

        .theme-info h4 {
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .theme-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Profile Modal */
        .profile-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            margin: -30px -30px 20px -30px;
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto 15px;
        }

        .profile-info-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-info-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .profile-info-value {
            font-size: 16px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .show {
            display: flex !important;
        }

        input[type="file"] {
            display: none;
        }

        /* Shericoin Balance */
        .shericoin-balance {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 20px;
            color: #333;
            font-weight: 600;
            margin: 10px 0;
            animation: coinPulse 2s infinite;
        }

        @keyframes coinPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .shericoin-icon {
            font-size: 20px;
        }

        /* Online Status */
        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-left: 5px;
            animation: statusPulse 2s infinite;
        }

        @keyframes statusPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .online-status.offline {
            background: #f44336;
            animation: none;
        }

        /* Premium Features */
        .premium-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            animation: premiumGlow 2s infinite;
        }

        @keyframes premiumGlow {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }

        /* Profile Color Selection */
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Emoji Background */
        .emoji-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        /* Channel Styles */
        .channel-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-primary);
        }

        .channel-item:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .channel-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
        }

        .channel-info {
            flex: 1;
            min-width: 0;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .channel-stats {
            font-size: 13px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Screen -->
        <div class="auth-screen" id="authScreen">
            <h1>Sherigram</h1>
            <div class="auth-form">
                <div id="emailStep">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="emailInput" placeholder="your@email.com">
                    </div>
                    <button class="btn" id="sendCodeBtn" onclick="sendEmailCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                    <p class="info-text">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∫–æ–¥ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É</p>
                </div>

                <div id="codeStep" class="hidden">
                    <div class="input-group">
                        <label>–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞</label>
                        <input type="text" id="codeInput" placeholder="123456" maxlength="6">
                    </div>
                    <button class="btn" onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    <p class="info-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É</p>
                </div>

                <div id="profileStep" class="hidden">
                    <div class="input-group">
                        <label>–í–∞—à–µ –∏–º—è</label>
                        <input type="text" id="nameInput" placeholder="–ò–≤–∞–Ω">
                    </div>
                    <div class="input-group">
                        <label>Username</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 12px; color: var(--text-secondary); font-size: 16px;">@</span>
                            <input type="text" id="usernameInput" placeholder="ivan123" style="padding-left: 28px;">
                        </div>
                    </div>
                    <button class="btn" onclick="completeRegistration()">–ù–∞—á–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Messenger -->
        <div class="messenger" id="messenger">
            <!-- Menu Overlay -->
            <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

            <!-- Sidebar Menu -->
            <div class="sidebar-menu" id="sidebarMenu">
                <div class="menu-header">
                    <div class="menu-user-info">
                        <div class="menu-avatar" id="menuAvatar">U</div>
                        <div class="menu-user-details">
                            <h3 id="menuUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                            <p id="menuUserEmail">email@example.com</p>
                        </div>
                    </div>
                    <!-- Shericoin Balance -->
                    <div class="shericoin-balance">
                        <span class="shericoin-icon">ü™ô</span>
                        <span id="shericoinBalance">0 Shericoin</span>
                    </div>
                </div>
                <div class="menu-items">
                    <div class="menu-item" onclick="openMyProfile()">
                        <span class="menu-item-icon">üë§</span>
                        <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                    </div>
                    <div class="menu-item" onclick="showFavorites()">
                        <span class="menu-item-icon">‚≠ê</span>
                        <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                    </div>
                    <div class="menu-item" onclick="openSavedMessages()">
                        <span class="menu-item-icon">üíæ</span>
                        <span>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</span>
                    </div>
                    <div class="menu-item" onclick="openChannels()">
                        <span class="menu-item-icon">üì¢</span>
                        <span>–ö–∞–Ω–∞–ª—ã</span>
                    </div>
                    <div class="menu-section">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="menu-item" onclick="openAccountSettings()">
                        <span class="menu-item-icon">‚úèÔ∏è</span>
                        <span>–ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
                    </div>
                    <div class="menu-item" id="adminBadgeMenuItem" style="display: none;" onclick="openAdminBadgeSettings()">
                        <span class="menu-item-icon">üëë</span>
                        <span>–ó–Ω–∞—á–æ–∫ –∞–¥–º–∏–Ω–∞</span>
                    </div>
                    <div class="menu-item" onclick="openThemeSettings()">
                        <span class="menu-item-icon">üé®</span>
                        <span>–¢–µ–º—ã</span>
                    </div>
                    <div class="menu-item" onclick="openPremiumSettings()">
                        <span class="menu-item-icon">üíé</span>
                        <span>–ü—Ä–µ–º–∏—É–º</span>
                    </div>
                    <div class="menu-item" onclick="logout()">
                        <span class="menu-item-icon">üö™</span>
                        <span>–í—ã–π—Ç–∏</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
                        <h2>Sherigram</h2>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="searchInput" onkeyup="searchContacts()">
                    <button class="add-contact-btn" onclick="openAddContactModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                    <button class="add-contact-btn" onclick="openCreateChannelModal()" style="margin-top: 5px; background: #FF6B35;">üì¢ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="chat-header" id="chatHeader" style="display: none;">
                    <button class="back-btn" onclick="event.stopPropagation(); backToChats()">‚Üê</button>
                    <div class="contact-avatar" id="chatAvatar" onclick="event.stopPropagation(); openUserProfile()">U</div>
                    <div class="chat-header-info" onclick="openUserProfile()">
                        <h3 id="chatName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                        <p id="chatStatus">–æ–Ω–ª–∞–π–Ω</p>
                    </div>
                    <button class="favorite-btn" id="favoriteBtn" onclick="event.stopPropagation(); toggleFavorite()">‚òÜ</button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                </div>

                <div class="reply-preview" id="replyPreview">
                    <button class="reply-preview-close" onclick="cancelReply()">‚úï</button>
                    <div class="reply-preview-header">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div class="reply-preview-text" id="replyPreviewText"></div>
                </div>

                <div class="chat-input" id="chatInput" style="display: none;">
                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                    <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <div class="input-group">
                <label>ID, email –∏–ª–∏ username</label>
                <input type="text" id="addContactInput" placeholder="ID123456, email –∏–ª–∏ @username">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAddContactModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="addContact()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="profile-header" id="profileHeader">
                <div class="emoji-background" id="profileEmojiBackground"></div>
                <div class="profile-avatar" id="profileAvatar">U</div>
                <h2 id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                <p id="profileDescription" style="opacity: 0.9; font-size: 14px; margin-top: 5px;"></p>
            </div>
            <div class="profile-info-item" id="profileEmailSection">
                <div class="profile-info-label">Email</div>
                <div class="profile-info-value" id="profileEmail">email@example.com</div>
            </div>
            <div class="profile-info-item">
                <div class="profile-info-label">Username</div>
                <div class="profile-info-value" id="profileUsername">@user</div>
            </div>
            <div class="profile-info-item">
                <div class="profile-info-label">ID</div>
                <div class="profile-info-value" id="profileId">ID123456</div>
            </div>
            <div class="profile-info-item">
                <div class="profile-info-label">–°—Ç–∞—Ç—É—Å</div>
                <div class="profile-info-value" id="profileStatus">
                    <span id="profileOnlineStatus">–æ–Ω–ª–∞–π–Ω</span>
                    <span class="online-status" id="profileOnlineIndicator"></span>
                </div>
            </div>
            <div id="adminDeleteSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #f44336;">
                <button class="btn" onclick="deleteUserAccount()" style="background: #f44336; width: 100%; margin-bottom: 10px;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç (ADMIN)
                </button>
                <button class="btn" onclick="toggleUserPremium()" style="background: #FFD700; color: #333; width: 100%; margin-bottom: 10px;">
                    üíé –°–¥–µ–ª–∞—Ç—å –ü—Ä–µ–º–∏—É–º
                </button>
                <button class="btn" onclick="toggleUserAdmin()" style="background: #667eea; width: 100%;">
                    üëë –°–¥–µ–ª–∞—Ç—å –ê–¥–º–∏–Ω–æ–º
                </button>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="accountSettingsModal">
        <div class="modal-content">
            <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
            <div class="input-group">
                <label>–ò–º—è</label>
                <input type="text" id="settingsName" placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            <div class="input-group">
                <label>Username</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 12px; top: 12px; color: var(--text-secondary); font-size: 16px;">@</span>
                    <input type="text" id="settingsUsername" placeholder="username" style="padding-left: 28px;">
                </div>
            </div>
            <div class="input-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label>
                <input type="text" id="settingsDescription" placeholder="–û —Å–µ–±–µ...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAccountSettings()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="saveAccountSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="themeModal">
        <div class="modal-content">
            <h2>–¢–µ–º—ã</h2>
            
            <!-- Shericoin Balance in Themes -->
            <div class="shericoin-balance" style="margin: 0 0 20px 0;">
                <span class="shericoin-icon">ü™ô</span>
                <span id="themeShericoinBalance">0 Shericoin</span>
            </div>
            
            <h3 style="margin: 20px 0 10px 0; color: var(--text-primary);">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
            <div class="theme-option" onclick="selectTheme('light')">
                <div class="theme-preview light">‚òÄÔ∏è</div>
                <div class="theme-info">
                    <h4>–°–≤–µ—Ç–ª–∞—è</h4>
                    <p>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</p>
                </div>
            </div>
            <div class="theme-option" onclick="selectTheme('dark')">
                <div class="theme-preview dark">üåô</div>
                <div class="theme-info">
                    <h4>–¢–µ–º–Ω–∞—è</h4>
                    <p>–ü—Ä–∏—è—Ç–Ω–∞—è –¥–ª—è –≥–ª–∞–∑ –≤ —Ç–µ–º–Ω–æ—Ç–µ</p>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0; color: var(--text-primary);">–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞</h3>
            <div class="theme-option" onclick="selectAccent('purple')">
                <div class="accent-preview purple"></div>
                <div class="theme-info">
                    <h4>–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</h4>
                    <p>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</p>
                </div>
            </div>
            <div class="theme-option" onclick="selectAccent('blue')">
                <div class="accent-preview blue"></div>
                <div class="theme-info">
                    <h4>–°–∏–Ω–∏–π</h4>
                    <p>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–∏–π</p>
                </div>
            </div>
            <div class="theme-option" onclick="selectAccent('green')">
                <div class="accent-preview green"></div>
                <div class="theme-info">
                    <h4>–ó–µ–ª–µ–Ω—ã–π</h4>
                    <p>–°–≤–µ–∂–∏–π –∑–µ–ª–µ–Ω—ã–π</p>
                </div>
            </div>
            <div class="theme-option" onclick="selectAccent('grey')">
                <div class="accent-preview grey"></div>
                <div class="theme-info">
                    <h4>–°–µ—Ä—ã–π</h4>
                    <p>–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</p>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeThemeSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Message Context Menu - HORIZONTAL -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item" onclick="giveShericoin()">
            <span class="context-menu-icon">ü™ô</span>
            <span class="context-menu-label">Shericoin</span>
        </div>
        <div class="context-menu-item" onclick="saveToFavorites()">
            <span class="context-menu-icon">üíæ</span>
            <span class="context-menu-label">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
        </div>
        <div class="context-menu-item" onclick="replyToMessage()">
            <span class="context-menu-icon">‚Ü©Ô∏è</span>
            <span class="context-menu-label">–û—Ç–≤–µ—Ç–∏—Ç—å</span>
        </div>
        <div class="context-menu-item" onclick="copyMessage()">
            <span class="context-menu-icon">üìã</span>
            <span class="context-menu-label">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
        </div>
        <div class="context-menu-item delete" onclick="deleteMessageFromMenu()">
            <span class="context-menu-icon">üóëÔ∏è</span>
            <span class="context-menu-label">–£–¥–∞–ª–∏—Ç—å</span>
        </div>
    </div>

    <!-- Saved Messages Modal -->
    <div class="modal" id="savedMessagesModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üíæ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <div id="savedMessagesList" style="max-height: 500px; overflow-y: auto; padding: 10px 0;">
                <!-- Saved messages will be loaded here -->
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeSavedMessages()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create Channel Modal -->
    <div class="modal" id="createChannelModal">
        <div class="modal-content">
            <h2>üì¢ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</h2>
            <div class="input-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                <input type="text" id="channelNameInput" placeholder="–ú–æ–π –∫–∞–Ω–∞–ª">
            </div>
            <div class="input-group">
                <label>Username –∫–∞–Ω–∞–ª–∞</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 12px; top: 12px; color: var(--text-secondary); font-size: 16px;">@</span>
                    <input type="text" id="channelUsernameInput" placeholder="mychannel" style="padding-left: 28px;">
                </div>
            </div>
            <div class="input-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" id="channelDescriptionInput" placeholder="–û —á–µ–º —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeCreateChannelModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Channels List Modal -->
    <div class="modal" id="channelsModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üì¢ –ö–∞–Ω–∞–ª—ã</h2>
            <div id="channelsList" style="max-height: 500px; overflow-y: auto; padding: 10px 0;">
                <!-- Channels will be loaded here -->
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="closeChannelsModal(); openCreateChannelModal();">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                <button class="btn-secondary" onclick="closeChannelsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Admin Badge Settings Modal -->
    <div class="modal" id="adminBadgeModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>üëë –ó–Ω–∞—á–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                –í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä—è–¥–æ–º —Å –≤–∞—à–∏–º –∏–º–µ–Ω–µ–º
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0;">
                <div class="theme-option" onclick="selectAdminBadge('üëë')" style="padding: 15px; text-align: center; cursor: pointer;">
                    <div style="font-size: 36px;">üëë</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">–ö–æ—Ä–æ–Ω–∞</div>
                </div>
                <div class="theme-option" onclick="selectAdminBadge('‚≠ê')" style="padding: 15px; text-align: center; cursor: pointer;">
                    <div style="font-size: 36px;">‚≠ê</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">–ó–≤–µ–∑–¥–∞</div>
                </div>
                <div class="theme-option" onclick="selectAdminBadge('üíé')" style="padding: 15px; text-align: center; cursor: pointer;">
                    <div style="font-size: 36px;">üíé</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">–ê–ª–º–∞–∑</div>
                </div>
                <div class="theme-option" onclick="selectAdminBadge('üî•')" style="padding: 15px; text-align: center; cursor: pointer;">
                    <div style="font-size: 36px;">üî•</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">–û–≥–æ–Ω—å</div>
                </div>
                <div class="theme-option" onclick="selectAdminBadge('‚ö°')" style="padding: 15px; text-align: center; cursor: pointer;">
                    <div style="font-size: 36px;">‚ö°</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">–ú–æ–ª–Ω–∏—è</div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAdminBadgeSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Premium Settings Modal -->
    <div class="modal" id="premiumModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>üíé –ü—Ä–µ–º–∏—É–º Sherigram</h2>
            
            <div class="shericoin-balance" style="margin: 0 0 20px 0;">
                <span class="shericoin-icon">ü™ô</span>
                <span id="premiumShericoinBalance">0 Shericoin</span>
            </div>

            <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 12px; color: #333; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">üíé –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å</h3>
                <p id="premiumStatusText" style="margin-bottom: 15px;">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</p>
                
                <div id="premiumBuySection">
                    <p style="margin-bottom: 15px; font-size: 14px;">
                        <strong>100 Shericoin</strong> –∑–∞ 1 –º–µ—Å—è—Ü –ø—Ä–µ–º–∏—É–º–∞
                    </p>
                    <button class="btn" onclick="buyPremium()" style="background: #333; color: white; width: 100%;">
                        üõí –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º
                    </button>
                </div>
                
                <div id="premiumActiveSection" style="display: none;">
                    <p style="margin-bottom: 15px; font-size: 14px;">
                        –ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–µ–Ω –¥–æ: <strong id="premiumExpiryDate">-</strong>
                    </p>
                    <button class="btn" onclick="extendPremium()" style="background: #333; color: white; width: 100%;">
                        üîÑ –ü—Ä–æ–¥–ª–∏—Ç—å –ø—Ä–µ–º–∏—É–º
                    </button>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0; color: var(--text-primary);">–ü—Ä–µ–º–∏—É–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</h3>
            <ul style="color: var(--text-secondary); font-size: 14px; line-height: 1.6; padding-left: 20px;">
                <li>–≠–º–æ–¥–∑–∏ —Ä—è–¥–æ–º —Å –Ω–∏–∫–æ–º</li>
                <li>–°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω</li>
                <li>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è</li>
                <li>–§–æ–Ω–æ–≤—ã–µ —ç–º–æ–¥–∑–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</li>
                <li>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</li>
            </ul>

            <!-- Profile Color Selection -->
            <h3 style="margin: 20px 0 10px 0; color: var(--text-primary);">–¶–≤–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <div class="color-option" style="background: #667eea;" onclick="selectProfileColor('#667eea')"></div>
                <div class="color-option" style="background: #f093fb;" onclick="selectProfileColor('#f093fb')"></div>
                <div class="color-option" style="background: #f5576c;" onclick="selectProfileColor('#f5576c')"></div>
                <div class="color-option" style="background: #4facfe;" onclick="selectProfileColor('#4facfe')"></div>
                <div class="color-option" style="background: #43e97b;" onclick="selectProfileColor('#43e97b')"></div>
                <div class="color-option" style="background: #ff9a9e;" onclick="selectProfileColor('#ff9a9e')"></div>
                <div class="color-option" style="background: #a8edea;" onclick="selectProfileColor('#a8edea')"></div>
                <div class="color-option" style="background: #fed6e3;" onclick="selectProfileColor('#fed6e3')"></div>
            </div>

            <!-- Emoji Background Selection -->
            <h3 style="margin: 20px 0 10px 0; color: var(--text-primary);">–§–æ–Ω–æ–≤—ã–π —ç–º–æ–¥–∑–∏</h3>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px;">
                <div class="theme-option" onclick="selectEmojiBackground('‚≠ê')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">‚≠ê</div>
                </div>
                <div class="theme-option" onclick="selectEmojiBackground('üíé')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">üíé</div>
                </div>
                <div class="theme-option" onclick="selectEmojiBackground('üî•')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">üî•</div>
                </div>
                <div class="theme-option" onclick="selectEmojiBackground('‚ö°')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">‚ö°</div>
                </div>
                <div class="theme-option" onclick="selectEmojiBackground('üåü')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">üåü</div>
                </div>
                <div class="theme-option" onclick="selectEmojiBackground('üéØ')" style="padding: 10px; text-align: center; cursor: pointer;">
                    <div style="font-size: 24px;">üéØ</div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closePremiumSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Channel View Modal -->
    <div class="modal" id="channelViewModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="profile-header" id="channelHeader">
                <div class="profile-avatar" id="channelAvatar">üì¢</div>
                <h2 id="channelViewName">–ö–∞–Ω–∞–ª</h2>
                <p id="channelViewUsername" style="opacity: 0.9;">@channel</p>
                <p id="channelViewDescription" style="opacity: 0.8; font-size: 14px; margin-top: 10px;"></p>
            </div>
            <div style="padding: 15px 0;">
                <div class="profile-info-item">
                    <div class="profile-info-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                    <div class="profile-info-value" id="channelSubscribers">0</div>
                </div>
                <div class="profile-info-item">
                    <div class="profile-info-label">–í–ª–∞–¥–µ–ª–µ—Ü</div>
                    <div class="profile-info-value" id="channelOwner">User</div>
                </div>
            </div>
            <div id="channelPostsSection" style="max-height: 300px; overflow-y: auto; margin: 10px 0;">
                <h3 style="color: var(--text-primary); margin-bottom: 10px;">–ü–æ—Å—Ç—ã</h3>
                <div id="channelPosts"></div>
            </div>
            <div id="channelPostInput" style="display: none; margin: 15px 0;">
                <textarea id="channelPostText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç..." style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; min-height: 80px; resize: vertical; background: var(--bg-secondary); color: var(--text-primary);"></textarea>
                <button class="btn" onclick="publishPost()" style="margin-top: 10px; width: 100%;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" id="channelActionBtn" onclick="toggleSubscription()">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                <button class="btn-secondary" onclick="closeChannelView()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================

const SUPABASE_URL = 'https://nymvzlumojprxmokkkvu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55bXZ6bHVtb2pwcnhtb2tra3Z1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNzc0NDQsImV4cCI6MjA3ODc1MzQ0NH0.Ogl4-mhzFuPBz3NnIBatACqyn0tCgWOHS_rJp7E0AAU';

const EMAILJS_SERVICE_ID = 'service_0jfph3s';
const EMAILJS_TEMPLATE_ID = 'template_yoqo4yr';
const EMAILJS_PUBLIC_KEY = 'zQNeeGhGe_8Tt-F3J';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentChat = null;
let allUsers = [];
let favorites = [];
let savedMessages = [];
let selectedMessage = null;
let replyToMsg = null;
let currentChannel = null;
let allChannels = [];
let viewingUserId = null;
let lastMessageCount = 0;
let adminBadges = {};
let userColors = {};
let userEmojiBackgrounds = {};
let userDescriptions = {};
let onlineStatus = {};
let userPremium = {};
let pendingMessages = new Map();
let allMessages = [];

const ADMINS = ['@monk', '@hello'];

// ============================================
// THEME MANAGEMENT
// ============================================

function loadTheme() {
    const theme = localStorage.getItem('theme') || 'light';
    const accent = localStorage.getItem('accent') || 'purple';
    document.body.className = `${theme} accent-${accent}`;
}

function selectTheme(theme) {
    localStorage.setItem('theme', theme);
    document.body.classList.remove('light', 'dark');
    document.body.classList.add(theme);
    showToast('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
}

function selectAccent(accent) {
    localStorage.setItem('accent', accent);
    document.body.classList.remove('accent-blue', 'accent-green', 'accent-grey', 'accent-purple');
    document.body.classList.add('accent-' + accent);
    showToast('–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω', 'success');
}

loadTheme();

// ============================================
// NOTIFICATIONS
// ============================================

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showPushNotification(senderName, messageText, avatar, onClick) {
    const notification = document.createElement('div');
    notification.className = 'push-notification';
    notification.onclick = onClick;
    
    notification.innerHTML = `
        <div class="notification-header">
            <div class="notification-avatar">${avatar}</div>
            <div class="notification-sender">${senderName}</div>
        </div>
        <div class="notification-text">${messageText}</div>
    `;
    
    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.add('hiding');
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// ============================================
// MENU CONTROLS
// ============================================

function toggleMenu() {
    document.getElementById('sidebarMenu').classList.toggle('open');
    document.getElementById('menuOverlay').classList.toggle('show');
}

function closeMenu() {
    document.getElementById('sidebarMenu').classList.remove('open');
    document.getElementById('menuOverlay').classList.remove('show');
}

function backToChats() {
    const sidebar = document.getElementById('sidebar');
    const chatArea = document.getElementById('chatArea');
    
    sidebar.classList.remove('mobile-hide');
    chatArea.classList.remove('mobile-show');
}

// ============================================
// AUTHENTICATION
// ============================================

async function sendEmailCode() {
    const email = document.getElementById('emailInput').value.trim();
    if (!email || !email.includes('@')) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
        return;
    }

    if (EMAILJS_SERVICE_ID === 'YOUR_SERVICE_ID' || 
        EMAILJS_TEMPLATE_ID === 'YOUR_TEMPLATE_ID' || 
        EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
        showToast('‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ EmailJS –≤ –∫–æ–¥–µ!', 'error');
        
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('tempCode', code);
        localStorage.setItem('tempEmail', email);
        
        document.getElementById('emailStep').classList.add('hidden');
        document.getElementById('codeStep').classList.remove('hidden');
        
        const infoText = document.querySelector('#codeStep .info-text');
        infoText.innerHTML = `<strong style="color: #f44336;">–î–ï–ú–û –†–ï–ñ–ò–ú</strong><br>–ö–æ–¥: <strong>${code}</strong><br><small>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ EmailJS –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º</small>`;
        return;
    }

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('tempCode', code);
    localStorage.setItem('tempEmail', email);

    const sendBtn = document.getElementById('sendCodeBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    showToast('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...', 'info');

    try {
        emailjs.init(EMAILJS_PUBLIC_KEY);

        const templateParams = {
            to_email: email,
            to_name: email.split('@')[0],
            verification_code: code,
            app_name: 'Sherigram'
        };

        const response = await emailjs.send(
            EMAILJS_SERVICE_ID,
            EMAILJS_TEMPLATE_ID,
            templateParams
        );

        console.log('EmailJS Success:', response);
        document.getElementById('emailStep').classList.add('hidden');
        document.getElementById('codeStep').classList.remove('hidden');
        showToast('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + email, 'success');
        
    } catch (error) {
        console.error('EmailJS Error:', error);
        showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (error.text || error.message), 'error');
        
        document.getElementById('emailStep').classList.add('hidden');
        document.getElementById('codeStep').classList.remove('hidden');
        
        const infoText = document.querySelector('#codeStep .info-text');
        infoText.innerHTML = `<strong style="color: #f44336;">–î–µ–º–æ —Ä–µ–∂–∏–º</strong><br>–ö–æ–¥: <strong>${code}</strong>`;
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
    }
}

async function verifyCode() {
    const enteredCode = document.getElementById('codeInput').value;
    const savedCode = localStorage.getItem('tempCode');

    if (enteredCode === savedCode) {
        const email = localStorage.getItem('tempEmail');
        
        try {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('phone', email)
                .single();

            if (data && !error) {
                currentUser = data;
                startMessenger();
            } else {
                document.getElementById('codeStep').classList.add('hidden');
                document.getElementById('profileStep').classList.remove('hidden');
            }
        } catch (err) {
            console.log('User not found, creating new');
            document.getElementById('codeStep').classList.add('hidden');
            document.getElementById('profileStep').classList.remove('hidden');
        }
    } else {
        showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 'error');
    }
}

async function completeRegistration() {
    const name = document.getElementById('nameInput').value.trim();
    let username = document.getElementById('usernameInput').value.trim();
    const email = localStorage.getItem('tempEmail');

    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error');
        return;
    }

    if (!username) {
        showToast('–í–≤–µ–¥–∏—Ç–µ username', 'error');
        return;
    }

    if (!username.startsWith('@')) {
        username = '@' + username;
    }

    await loadAllUsers();
    const existingUser = allUsers.find(u => u.username && u.username.toLowerCase() === username.toLowerCase());
    
    if (existingUser) {
        showToast('–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π', 'error');
        return;
    }

    const userId = 'ID' + Date.now().toString().slice(-6);

    try {
        const insertData = { 
            user_id: userId, 
            phone: email, 
            name: name, 
            username: username,
            shericoin_balance: 10
        };

        console.log('Attempting to insert:', insertData);

        const { data, error } = await supabase
            .from('users')
            .insert([insertData])
            .select();

        console.log('Insert response - data:', data, 'error:', error);

        if (error) {
            console.error('Supabase error details:', {
                message: error.message,
                details: error.details,
                hint: error.hint,
                code: error.code
            });
            showToast('–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + (error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            return;
        }

        currentUser = data && data[0] ? data[0] : {
            user_id: userId,
            phone: email,
            name: name,
            username: username,
            shericoin_balance: 10
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Sherigram!', 'success');
        startMessenger();
    } catch (err) {
        console.error('Catch error details:', {
            name: err.name,
            message: err.message,
            stack: err.stack
        });
        showToast('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + err.message, 'error');
    }
}

// ============================================
// SHERICOIN MANAGEMENT
// ============================================

async function loadShericoinFromDatabase() {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('shericoin_balance')
            .eq('user_id', currentUser.user_id)
            .single();
        
        if (data && data.shericoin_balance !== null && data.shericoin_balance !== undefined) {
            localStorage.setItem('shericoin_' + currentUser.user_id, data.shericoin_balance.toString());
            return data.shericoin_balance;
        } else {
            const initialBalance = 10;
            await updateShericoinInDatabase(initialBalance);
            localStorage.setItem('shericoin_' + currentUser.user_id, initialBalance.toString());
            return initialBalance;
        }
    } catch (error) {
        console.error('Error loading shericoin:', error);
        const initialBalance = 10;
        localStorage.setItem('shericoin_' + currentUser.user_id, initialBalance.toString());
        return initialBalance;
    }
}

async function updateShericoinInDatabase(amount) {
    try {
        const { error } = await supabase
            .from('users')
            .update({ shericoin_balance: amount })
            .eq('user_id', currentUser.user_id);
        
        if (error) {
            console.error('Error updating shericoin in database:', error);
            return false;
        }
        return true;
    } catch (error) {
        console.error('Error updating shericoin:', error);
        return false;
    }
}

async function addShericoin(amount) {
    const currentBalance = await getCurrentShericoinBalance();
    const newBalance = currentBalance + amount;
    
    const success = await updateShericoinInDatabase(newBalance);
    if (success) {
        localStorage.setItem('shericoin_' + currentUser.user_id, newBalance.toString());
        updateShericoinBalance();
        return true;
    }
    return false;
}

async function deductShericoin(amount) {
    const currentBalance = await getCurrentShericoinBalance();
    
    if (currentBalance < amount) {
        return false;
    }
    
    const newBalance = currentBalance - amount;
    const success = await updateShericoinInDatabase(newBalance);
    if (success) {
        localStorage.setItem('shericoin_' + currentUser.user_id, newBalance.toString());
        updateShericoinBalance();
        return true;
    }
    return false;
}

async function getCurrentShericoinBalance() {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('shericoin_balance')
            .eq('user_id', currentUser.user_id)
            .single();
        
        if (data && data.shericoin_balance !== null && data.shericoin_balance !== undefined) {
            const dbBalance = data.shericoin_balance;
            localStorage.setItem('shericoin_' + currentUser.user_id, dbBalance.toString());
            return dbBalance;
        }
    } catch (error) {
        console.error('Error getting shericoin balance:', error);
    }
    
    return parseInt(localStorage.getItem('shericoin_' + currentUser.user_id) || '10');
}

function updateShericoinBalance() {
    const balance = parseInt(localStorage.getItem('shericoin_' + currentUser.user_id) || '10');
    document.getElementById('shericoinBalance').textContent = balance + ' Shericoin';
    document.getElementById('themeShericoinBalance').textContent = balance + ' Shericoin';
    document.getElementById('premiumShericoinBalance').textContent = balance + ' Shericoin';
}

// ============================================
// MESSENGER INITIALIZATION
// ============================================

async function startMessenger() {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('messenger').classList.add('show');
    
    adminBadges = JSON.parse(localStorage.getItem('adminBadges') || '{}');
    userColors = JSON.parse(localStorage.getItem('userColors') || '{}');
    userEmojiBackgrounds = JSON.parse(localStorage.getItem('userEmojiBackgrounds') || '{}');
    userDescriptions = JSON.parse(localStorage.getItem('userDescriptions') || '{}');
    onlineStatus = JSON.parse(localStorage.getItem('onlineStatus') || '{}');
    userPremium = JSON.parse(localStorage.getItem('userPremium') || '{}');
    
    onlineStatus[currentUser.user_id] = true;
    localStorage.setItem('onlineStatus', JSON.stringify(onlineStatus));
    
    await loadShericoinFromDatabase();
    
    updateUserDisplay();
    
    if (ADMINS.includes(currentUser.username)) {
        document.getElementById('adminBadgeMenuItem').style.display = 'flex';
    }

    favorites = JSON.parse(localStorage.getItem('favorites_' + currentUser.user_id) || '[]');
    savedMessages = JSON.parse(localStorage.getItem('savedMessages_' + currentUser.user_id) || '[]');
    
    await loadAllUsers();
    await loadChannels();
    await loadChats();
    
    await createSherigramChannel();
    
    setInterval(async () => {
        if (currentChat) {
            await loadMessages();
        }
        await loadChats();
        await loadChannels();
        updateOnlineStatus();
        
        await checkForNewMessages();
    }, 2000);
}

async function checkForNewMessages() {
    if (!currentUser) return;
    
    const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('to_user_id', currentUser.user_id)
        .eq('is_read', false)
        .order('created_at', { ascending: false });

    if (data && data.length > 0) {
        data.forEach(msg => {
            const sender = allUsers.find(u => u.user_id === msg.from_user_id);
            if (sender && (!currentChat || currentChat.user_id !== sender.user_id)) {
                showPushNotification(
                    sender.name,
                    msg.message_text || 'üì∑ –§–æ—Ç–æ',
                    sender.name[0].toUpperCase(),
                    () => {
                        openChat(sender);
                        const notifications = document.querySelectorAll('.push-notification');
                        notifications.forEach(n => n.remove());
                    }
                );
            }
        });
    }
}

function updateUserDisplay() {
    const adminBadge = ADMINS.includes(currentUser.username) ? (adminBadges[currentUser.username] || 'üëë') : '';
    const isPremium = userPremium[currentUser.user_id] && new Date(userPremium[currentUser.user_id]) > new Date();
    const premiumBadge = isPremium ? '<span class="premium-badge">PREMIUM</span>' : '';
    
    let displayName = currentUser.name;
    if (adminBadge) {
        displayName += ' ' + adminBadge;
    }
    
    document.getElementById('menuAvatar').textContent = currentUser.name[0].toUpperCase();
    document.getElementById('menuUserName').innerHTML = displayName + premiumBadge;
    document.getElementById('menuUserEmail').textContent = currentUser.phone;
    
    const userColor = userColors[currentUser.user_id] || '#667eea';
    document.getElementById('menuAvatar').style.background = `linear-gradient(135deg, ${userColor}, ${userColor})`;
    
    updateShericoinBalance();
}

function updateOnlineStatus() {
    onlineStatus[currentUser.user_id] = true;
    localStorage.setItem('onlineStatus', JSON.stringify(onlineStatus));
}

async function loadAllUsers() {
    const { data, error } = await supabase.from('users').select('*');
    if (data) allUsers = data;
}

// ============================================
// CONTACTS & CHATS
// ============================================

async function loadChats() {
    const { data: messagesData, error: msgError } = await supabase
        .from('messages')
        .select('*')
        .or(`from_user_id.eq.${currentUser.user_id},to_user_id.eq.${currentUser.user_id}`)
        .order('created_at', { ascending: false });

    await loadChannels();
    const userChannels = allChannels.filter(ch => 
        ch.subscribers && ch.subscribers.includes(currentUser.user_id)
    );

    const contactsList = document.getElementById('contactsList');
    contactsList.innerHTML = '';

    const savedDiv = document.createElement('div');
    savedDiv.className = 'contact-item';
    savedDiv.onclick = () => openSavedMessages();
    savedDiv.innerHTML = `
        <div class="contact-avatar" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
            üíæ
        </div>
        <div class="contact-info">
            <div class="contact-name">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
            <div class="contact-last-msg">${savedMessages.length > 0 ? savedMessages.length + ' —Å–æ–æ–±—â–µ–Ω–∏–π' : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
        </div>
    `;
    contactsList.appendChild(savedDiv);

    userChannels.forEach(channel => {
        const channelDiv = document.createElement('div');
        channelDiv.className = 'channel-item';
        channelDiv.onclick = () => openChannelView(channel);
        
        const isOwner = channel.owner_id === currentUser.user_id;
        
        channelDiv.innerHTML = `
            <div class="channel-avatar">
                üì¢
            </div>
            <div class="channel-info">
                <div class="channel-name">${channel.name} ${isOwner ? 'üëë' : ''}</div>
                <div class="channel-stats">${channel.subscribers?.length || 0} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
            </div>
        `;
        contactsList.appendChild(channelDiv);
    });

    if (!messagesData && userChannels.length === 0 && savedMessages.length === 0) {
        contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç —á–∞—Ç–æ–≤.<br>–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç!</div>';
        return;
    }

    if (messagesData && messagesData.length > 0) {
        const contactIds = new Set();
        messagesData.forEach(msg => {
            const otherId = msg.from_user_id === currentUser.user_id ? msg.to_user_id : msg.from_user_id;
            contactIds.add(otherId);
        });

        const contactsArray = Array.from(contactIds).sort((a, b) => {
            const aFav = favorites.includes(a);
            const bFav = favorites.includes(b);
            if (aFav && !bFav) return -1;
            if (!aFav && bFav) return 1;
            return 0;
        });

        contactsArray.forEach(contactId => {
            const user = allUsers.find(u => u.user_id === contactId);
            if (!user) return;

            const userMessages = messagesData.filter(m => 
                (m.from_user_id === user.user_id || m.to_user_id === user.user_id)
            );
            const lastMsg = userMessages[0];
            const isFavorite = favorites.includes(user.user_id);

            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-item' + (isFavorite ? ' favorite' : '');
            if (currentChat && currentChat.user_id === user.user_id) {
                contactDiv.classList.add('active');
            }
            contactDiv.onclick = () => openChat(user);
            
            let displayName = user.name;
            if (ADMINS.includes(user.username)) {
                const badge = adminBadges[user.username] || 'üëë';
                displayName += ' ' + badge;
            }
            
            const isPremium = userPremium[user.user_id] && new Date(userPremium[user.user_id]) > new Date();
            if (isPremium) {
                displayName += ' <span class="premium-badge">PREMIUM</span>';
            }
            
            const isOnline = onlineStatus[user.user_id];
            const onlineIndicator = isOnline ? '<span class="online-status"></span>' : '<span class="online-status offline"></span>';
            
            contactDiv.innerHTML = `
                <div class="contact-avatar" style="background: linear-gradient(135deg, ${userColors[user.user_id] || '#667eea'}, ${userColors[user.user_id] || '#667eea'});">
                    ${isFavorite ? '<span class="favorite-badge">‚≠ê</span>' : ''}
                    ${user.name[0].toUpperCase()}
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName} ${onlineIndicator}</div>
                    <div class="contact-last-msg">${lastMsg ? (lastMsg.message_text || 'üì∑ –§–æ—Ç–æ') : ''}</div>
                </div>
            `;
            contactsList.appendChild(contactDiv);
        });
    }
}

function searchContacts() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.contact-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? 'flex' : 'none';
    });
}

function showFavorites() {
    const query = '';
    document.getElementById('searchInput').value = '';
    const items = document.querySelectorAll('.contact-item');
    items.forEach(item => {
        const hasStarBadge = item.innerHTML.includes('favorite-badge');
        item.style.display = hasStarBadge ? 'flex' : 'none';
    });
    closeMenu();
    showToast('–ü–æ–∫–∞–∑–∞–Ω—ã –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã', 'info');
}

function openAddContactModal() {
    document.getElementById('addContactModal').classList.add('show');
}

function closeAddContactModal() {
    document.getElementById('addContactModal').classList.remove('show');
    document.getElementById('addContactInput').value = '';
}

async function addContact() {
    const input = document.getElementById('addContactInput').value.trim();
    
    if (!input) {
        showToast('–í–≤–µ–¥–∏—Ç–µ ID, email –∏–ª–∏ username', 'error');
        return;
    }

    await loadAllUsers();

    const foundUser = allUsers.find(u => 
        u.user_id === input || 
        u.phone === input || 
        u.username === input ||
        u.phone.replace(/\s/g, '') === input.replace(/\s/g, '')
    );

    if (!foundUser) {
        showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }

    if (foundUser.user_id === currentUser.user_id) {
        showToast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è', 'error');
        return;
    }

    openChat(foundUser);
    closeAddContactModal();
    showToast('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω: ' + foundUser.name, 'success');
}

// ============================================
// CHAT FUNCTIONALITY
// ============================================

function openChat(user) {
    currentChat = user;
    
    const sidebar = document.getElementById('sidebar');
    const chatArea = document.getElementById('chatArea');
    
    sidebar.classList.add('mobile-hide');
    chatArea.classList.add('mobile-show');
    
    document.querySelectorAll('.contact-item').forEach(item => {
        item.classList.remove('active');
    });

    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('chatInput').style.display = 'flex';
    
    const userColor = userColors[user.user_id] || '#667eea';
    document.getElementById('chatAvatar').style.background = `linear-gradient(135deg, ${userColor}, ${userColor})`;
    document.getElementById('chatAvatar').textContent = user.name[0].toUpperCase();
    
    let displayName = user.name;
    if (ADMINS.includes(user.username)) {
        const badge = adminBadges[user.username] || 'üëë';
        displayName += ' ' + badge;
    }
    
    const isPremium = userPremium[user.user_id] && new Date(userPremium[user.user_id]) > new Date();
    if (isPremium) {
        displayName += ' <span class="premium-badge">PREMIUM</span>';
    }
    
    document.getElementById('chatName').innerHTML = displayName;
    
    const isOnline = onlineStatus[user.user_id];
    document.getElementById('chatStatus').innerHTML = isOnline ? 
        '–æ–Ω–ª–∞–π–Ω <span class="online-status"></span>' : 
        '–æ—Ñ–ª–∞–π–Ω <span class="online-status offline"></span>';

    const isFavorite = favorites.includes(user.user_id);
    document.getElementById('favoriteBtn').textContent = isFavorite ? '‚≠ê' : '‚òÜ';

    loadMessages();
}

function toggleFavorite() {
    if (!currentChat) return;

    const index = favorites.indexOf(currentChat.user_id);
    if (index > -1) {
        favorites.splice(index, 1);
        showToast('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'info');
    } else {
        favorites.push(currentChat.user_id);
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
    }

    localStorage.setItem('favorites_' + currentUser.user_id, JSON.stringify(favorites));
    document.getElementById('favoriteBtn').textContent = favorites.includes(currentChat.user_id) ? '‚≠ê' : '‚òÜ';
    loadChats();
}

async function loadMessages() {
    if (!currentChat) return;

    const chatMessages = document.getElementById('chatMessages');
    
    const { data, error } = await supabase
        .from('messages')
        .select('*')
        .or(`and(from_user_id.eq.${currentUser.user_id},to_user_id.eq.${currentChat.user_id}),and(from_user_id.eq.${currentChat.user_id},to_user_id.eq.${currentUser.user_id})`)
        .order('created_at', { ascending: true });

    if (!data || data.length === 0) {
        if (pendingMessages.size === 0) {
            chatMessages.innerHTML = '<div class="empty-chat">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
        }
        lastMessageCount = 0;
        return;
    }

    allMessages = data;

    const unreadIds = data.filter(m => m.to_user_id === currentUser.user_id && !m.is_read).map(m => m.id);
    if (unreadIds.length > 0) {
        await supabase
            .from('messages')
            .update({ is_read: true })
            .in('id', unreadIds);
    }

    chatMessages.innerHTML = '';
    
    data.forEach((msg, index) => {
        const isSent = msg.from_user_id === currentUser.user_id;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.setAttribute('data-message-id', msg.id);
        
        let content = `<div class="message-content">`;
        
        if (msg.reply_to) {
            const replyMsg = data.find(m => m.id === msg.reply_to);
            if (replyMsg) {
                content += `<div class="message-reply">
                    <div class="message-reply-header">${replyMsg.from_user_id === currentUser.user_id ? '–í—ã' : currentChat.name}</div>
                    <div class="message-reply-text">${replyMsg.message_text || 'üì∑ –§–æ—Ç–æ'}</div>
                </div>`;
            }
        }
        
        if (msg.message_text) {
            content += `<div class="message-text">${msg.message_text}</div>`;
        }
        
        if (msg.file_data && msg.message_type === 'image') {
            content += `<img src="${msg.file_data}" class="message-image" onclick="event.stopPropagation(); window.open('${msg.file_data}')">`;
        }
        
        const time = new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        content += `<div class="message-footer">`;
        content += `<span>${time}</span>`;
        
        if (isSent) {
            content += `<span class="message-status">${msg.is_read ? '‚úì‚úì' : '‚úì'}</span>`;
        }
        
        content += `</div></div>`;
        
        messageDiv.innerHTML = content;
        chatMessages.appendChild(messageDiv);
    });

    pendingMessages.forEach((msg, tempId) => {
        if (msg.to_user_id === currentChat.user_id) {
            addMessageToChat(msg);
        }
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;
    lastMessageCount = data.length;
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();

    if (!text || !currentChat) return;

    const tempId = 'temp_' + Date.now();
    const messageData = {
        id: tempId,
        from_user_id: currentUser.user_id,
        to_user_id: currentChat.user_id,
        message_text: text,
        message_type: 'text',
        is_read: false,
        created_at: new Date().toISOString(),
        status: 'sending'
    };

    if (replyToMsg) {
        messageData.reply_to = replyToMsg.id;
    }

    addMessageToChat(messageData, true);
    pendingMessages.set(tempId, messageData);

    input.value = '';
    cancelReply();

    const dbMessageData = {
        from_user_id: currentUser.user_id,
        to_user_id: currentChat.user_id,
        message_text: text,
        message_type: 'text',
        is_read: false
    };

    if (replyToMsg) {
        dbMessageData.reply_to = replyToMsg.id;
    }

    const { data, error } = await supabase
        .from('messages')
        .insert([dbMessageData])
        .select();

    if (error) {
        updateMessageStatus(tempId, 'error');
        showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        return;
    }

    if (data && data[0]) {
        updateMessageStatus(tempId, 'sent', data[0].id);
        pendingMessages.delete(tempId);
        
        const success = await addShericoin(1);
        if (success) {
            showToast('+1 Shericoin –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ!', 'success');
        }
    }

    await loadChats();
}

function addMessageToChat(message, isNew = false) {
    const chatMessages = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message sent ${isNew ? 'new-message' : ''} ${message.status === 'sending' ? 'sending' : ''}`;
    messageDiv.setAttribute('data-message-id', message.id);
    
    let content = `<div class="message-content">`;
    
    if (message.reply_to) {
        const replyMsg = Array.from(pendingMessages.values()).find(m => m.id === message.reply_to) || 
                       allMessages?.find(m => m.id === message.reply_to);
        if (replyMsg) {
            content += `<div class="message-reply">
                <div class="message-reply-header">${replyMsg.from_user_id === currentUser.user_id ? '–í—ã' : currentChat.name}</div>
                <div class="message-reply-text">${replyMsg.message_text || 'üì∑ –§–æ—Ç–æ'}</div>
            </div>`;
        }
    }
    
    if (message.message_text) {
        content += `<div class="message-text">${message.message_text}</div>`;
    }
    
    const time = new Date(message.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    content += `<div class="message-footer">`;
    content += `<span>${time}</span>`;
    
    let statusIcon = '‚úì';
    if (message.status === 'sending') {
        statusIcon = '<span class="message-status sending">üïí</span>';
    } else if (message.status === 'error') {
        statusIcon = '‚úó';
    } else if (message.status === 'sent') {
        statusIcon = '‚úì‚úì';
    }
    
    content += `<span class="message-status">${statusIcon}</span>`;
    content += `</div></div>`;
    
    messageDiv.innerHTML = content;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function updateMessageStatus(tempId, status, realId = null) {
    const messageDiv = document.querySelector(`[data-message-id="${tempId}"]`);
    if (!messageDiv) return;

    const statusElement = messageDiv.querySelector('.message-status');
    if (!statusElement) return;

    if (status === 'sending') {
        statusElement.innerHTML = '<span class="message-status sending">üïí</span>';
    } else if (status === 'error') {
        statusElement.textContent = '‚úó';
        messageDiv.classList.add('sending');
    } else if (status === 'sent') {
        statusElement.textContent = '‚úì‚úì';
        messageDiv.classList.remove('sending');
        if (realId) {
            messageDiv.setAttribute('data-message-id', realId);
        }
    }
}

function handleEnter(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
}

async function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file || !currentChat) return;

    if (file.size > 5000000) {
        showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(event) {
        const messageType = file.type.startsWith('image/') ? 'image' : 'file';
        const messageText = file.type.startsWith('image/') ? 'üì∑ –§–æ—Ç–æ' : 'üìé ' + file.name;

        const { data, error } = await supabase
            .from('messages')
            .insert([{
                from_user_id: currentUser.user_id,
                to_user_id: currentChat.user_id,
                message_text: messageText,
                message_type: messageType,
                file_data: event.target.result,
                file_name: file.name,
                is_read: false
            }]);

        if (error) {
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞', 'error');
            return;
        }

        const success = await addShericoin(1);
        if (success) {
            showToast('+1 Shericoin –∑–∞ —Ñ–∞–π–ª!', 'success');
        }

        await loadMessages();
    };

    reader.readAsDataURL(file);
    e.target.value = '';
}

// ============================================
// MESSAGE CONTEXT MENU
// ============================================

function showMessageContextMenu(e, message) {
    e.preventDefault();
    e.stopPropagation();
    
    selectedMessage = message;
    const menu = document.getElementById('messageContextMenu');
    
    menu.style.left = (e.pageX - 100) + 'px';
    menu.style.top = (e.pageY + 10) + 'px';
    menu.classList.add('show');
    
    setTimeout(() => {
        document.addEventListener('click', closeContextMenu);
    }, 10);
}

function closeContextMenu() {
    document.getElementById('messageContextMenu').classList.remove('show');
    document.removeEventListener('click', closeContextMenu);
}

async function giveShericoin() {
    if (!selectedMessage) return;
    
    const success = await deductShericoin(1);
    if (!success) {
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Shericoin!', 'error');
        closeContextMenu();
        return;
    }
    
    const receiver = allUsers.find(u => u.user_id === selectedMessage.from_user_id);
    if (!receiver) {
        showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        closeContextMenu();
        return;
    }
    
    try {
        const { data: receiverData } = await supabase
            .from('users')
            .select('shericoin_balance')
            .eq('user_id', receiver.user_id)
            .single();
            
        const receiverBalance = (receiverData?.shericoin_balance || 0) + 1;
        
        await supabase
            .from('users')
            .update({ shericoin_balance: receiverBalance })
            .eq('user_id', receiver.user_id);
    } catch (error) {
        console.error('Error giving shericoin to receiver:', error);
    }
    
    showToast(`–í—ã –ø–æ–¥–∞—Ä–∏–ª–∏ 1 Shericoin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${receiver.name}`, 'success');
    closeContextMenu();
}

function saveToFavorites() {
    if (!selectedMessage) return;
    
    const saved = {
        id: selectedMessage.id,
        message_text: selectedMessage.message_text,
        file_data: selectedMessage.file_data,
        message_type: selectedMessage.message_type,
        from_user: currentChat.name,
        saved_at: new Date().toISOString()
    };
    
    savedMessages.push(saved);
    localStorage.setItem('savedMessages_' + currentUser.user_id, JSON.stringify(savedMessages));
    
    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
    closeContextMenu();
    
    loadChats();
}

function replyToMessage() {
    if (!selectedMessage) return;
    
    replyToMsg = selectedMessage;
    document.getElementById('replyPreview').classList.add('show');
    document.getElementById('replyPreviewText').textContent = selectedMessage.message_text || 'üì∑ –§–æ—Ç–æ';
    document.getElementById('messageInput').focus();
    
    closeContextMenu();
}

function cancelReply() {
    replyToMsg = null;
    document.getElementById('replyPreview').classList.remove('show');
}

function copyMessage() {
    if (!selectedMessage || !selectedMessage.message_text) {
        showToast('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
        closeContextMenu();
        return;
    }
    
    navigator.clipboard.writeText(selectedMessage.message_text).then(() => {
        showToast('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
    }).catch(() => {
        showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
    });
    
    closeContextMenu();
}

function deleteMessageFromMenu() {
    if (!selectedMessage) return;
    
    if (selectedMessage.from_user_id !== currentUser.user_id) {
        showToast('–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        closeContextMenu();
        return;
    }
    
    deleteMessage(selectedMessage.id);
    closeContextMenu();
}

async function deleteMessage(messageId) {
    const { error } = await supabase
        .from('messages')
        .delete()
        .eq('id', messageId);

    if (error) {
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        return;
    }

    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
    await loadMessages();
    await loadChats();
}

function openSavedMessages() {
    const list = document.getElementById('savedMessagesList');
    
    if (savedMessages.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    } else {
        list.innerHTML = '';
        savedMessages.forEach((msg, index) => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message received';
            msgDiv.style.cssText = 'margin-bottom: 15px;';
            
            const time = new Date(msg.saved_at).toLocaleString('ru-RU', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            msgDiv.innerHTML = `
                <div class="message-content" style="max-width: 100%; position: relative;">
                    <div style="font-size: 12px; color: var(--accent-color); font-weight: 600; margin-bottom: 5px;">
                        ${msg.from_user}
                    </div>
                    ${msg.message_text ? `<div class="message-text">${msg.message_text}</div>` : ''}
                    ${msg.file_data && msg.message_type === 'image' ? 
                        `<img src="${msg.file_data}" class="message-image" onclick="window.open('${msg.file_data}')">` : ''}
                    <div class="message-footer">
                        <span>${time}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteSavedMessage(${index})" 
                        style="position: absolute; top: 5px; right: 5px; background: rgba(244, 67, 54, 0.8); 
                        border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; 
                        font-size: 12px; transition: background 0.2s;">
                        ‚úï
                    </button>
                </div>
            `;
            list.appendChild(msgDiv);
        });
    }
    
    document.getElementById('savedMessagesModal').classList.add('show');
    closeMenu();
}

function closeSavedMessages() {
    document.getElementById('savedMessagesModal').classList.remove('show');
}

function deleteSavedMessage(index) {
    savedMessages.splice(index, 1);
    localStorage.setItem('savedMessages_' + currentUser.user_id, JSON.stringify(savedMessages));
    openSavedMessages();
    loadChats();
    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'info');
}

// ============================================
// PROFILE & SETTINGS
// ============================================

function openUserProfile() {
    if (!currentChat) return;
    
    viewingUserId = currentChat.user_id;
    updateProfileModal();
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('show');
    viewingUserId = null;
}

function openMyProfile() {
    viewingUserId = currentUser.user_id;
    updateProfileModal();
    closeMenu();
}

function updateProfileModal() {
    const user = viewingUserId === currentUser.user_id ? currentUser : 
                allUsers.find(u => u.user_id === viewingUserId);
    
    if (!user) return;

    const userColor = userColors[user.user_id] || '#667eea';
    document.getElementById('profileHeader').style.background = `linear-gradient(135deg, ${userColor}, ${userColor})`;
    document.getElementById('profileAvatar').style.background = `rgba(255,255,255,0.3)`;
    document.getElementById('profileAvatar').textContent = user.name[0].toUpperCase();
    
    const emojiBackground = userEmojiBackgrounds[user.user_id];
    if (emojiBackground) {
        document.getElementById('profileEmojiBackground').textContent = emojiBackground;
        document.getElementById('profileEmojiBackground').style.display = 'flex';
    } else {
        document.getElementById('profileEmojiBackground').style.display = 'none';
    }
    
    let displayName = user.name;
    if (ADMINS.includes(user.username)) {
        const badge = adminBadges[user.username] || 'üëë';
        displayName += ' ' + badge;
    }
    
    const isPremium = userPremium[user.user_id] && new Date(userPremium[user.user_id]) > new Date();
    if (isPremium) {
        displayName += ' <span class="premium-badge">PREMIUM</span>';
    }
    
    document.getElementById('profileName').innerHTML = displayName;
    document.getElementById('profileUsername').textContent = user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('profileId').textContent = user.user_id;
    
    const description = userDescriptions[user.user_id];
    document.getElementById('profileDescription').textContent = description || '';
    
    const isOnline = onlineStatus[user.user_id];
    document.getElementById('profileOnlineStatus').textContent = isOnline ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω';
    document.getElementById('profileOnlineIndicator').className = isOnline ? 'online-status' : 'online-status offline';
    
    if (viewingUserId === currentUser.user_id) {
        document.getElementById('profileEmailSection').style.display = 'block';
        document.getElementById('profileEmail').textContent = user.phone;
    } else {
        document.getElementById('profileEmailSection').style.display = 'none';
    }
    
    const adminSection = document.getElementById('adminDeleteSection');
    if (ADMINS.includes(currentUser.username) && viewingUserId !== currentUser.user_id) {
        adminSection.style.display = 'block';
        
        const isUserPremium = userPremium[viewingUserId] && new Date(userPremium[viewingUserId]) > new Date();
        const premiumBtn = adminSection.querySelector('button:nth-child(2)');
        premiumBtn.textContent = isUserPremium ? 'üíé –£–±—Ä–∞—Ç—å –ü—Ä–µ–º–∏—É–º' : 'üíé –°–¥–µ–ª–∞—Ç—å –ü—Ä–µ–º–∏—É–º';
        
        const isUserAdmin = ADMINS.includes(user.username);
        const adminBtn = adminSection.querySelector('button:nth-child(3)');
        adminBtn.textContent = isUserAdmin ? 'üëë –£–±—Ä–∞—Ç—å –ê–¥–º–∏–Ω–∞' : 'üëë –°–¥–µ–ª–∞—Ç—å –ê–¥–º–∏–Ω–æ–º';
    } else {
        adminSection.style.display = 'none';
    }
    
    document.getElementById('profileModal').classList.add('show');
}

async function deleteUserAccount() {
    if (!ADMINS.includes(currentUser.username)) {
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
        return;
    }
    
    if (!viewingUserId || viewingUserId === currentUser.user_id) {
        showToast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç', 'error');
        return;
    }
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('users')
            .delete()
            .eq('user_id', viewingUserId);
        
        if (error) {
            showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
            return;
        }
        
        await supabase
            .from('messages')
            .delete()
            .or(`from_user_id.eq.${viewingUserId},to_user_id.eq.${viewingUserId}`);
        
        showToast('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
        closeProfileModal();
        
        if (currentChat && currentChat.user_id === viewingUserId) {
            currentChat = null;
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('chatInput').style.display = 'none';
            document.getElementById('chatMessages').innerHTML = '<div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>';
        }
        
        await loadAllUsers();
        await loadChats();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
    }
}

function toggleUserPremium() {
    if (!ADMINS.includes(currentUser.username) || !viewingUserId) {
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
        return;
    }
    
    const isCurrentlyPremium = userPremium[viewingUserId] && new Date(userPremium[viewingUserId]) > new Date();
    
    if (isCurrentlyPremium) {
        delete userPremium[viewingUserId];
        showToast('–ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å —É–±—Ä–∞–Ω', 'info');
    } else {
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30);
        userPremium[viewingUserId] = expiryDate.toISOString();
        showToast('–ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å –≤—ã–¥–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π', 'success');
    }
    
    localStorage.setItem('userPremium', JSON.stringify(userPremium));
    updateProfileModal();
    loadChats();
}

function toggleUserAdmin() {
    if (!ADMINS.includes(currentUser.username) || !viewingUserId) {
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
        return;
    }
    
    const user = allUsers.find(u => u.user_id === viewingUserId);
    if (!user) return;
    
    const isCurrentlyAdmin = ADMINS.includes(user.username);
    
    if (isCurrentlyAdmin) {
        showToast('–ê–¥–º–∏–Ω –ø—Ä–∞–≤–∞ —É–±—Ä–∞–Ω—ã', 'info');
    } else {
        showToast('–ê–¥–º–∏–Ω –ø—Ä–∞–≤–∞ –≤—ã–¥–∞–Ω—ã', 'success');
    }
    
    updateProfileModal();
    loadChats();
}

function openAccountSettings() {
    document.getElementById('settingsName').value = currentUser.name;
    const usernameValue = currentUser.username ? currentUser.username.replace('@', '') : '';
    document.getElementById('settingsUsername').value = usernameValue;
    document.getElementById('settingsDescription').value = userDescriptions[currentUser.user_id] || '';
    document.getElementById('accountSettingsModal').classList.add('show');
    closeMenu();
}

function closeAccountSettings() {
    document.getElementById('accountSettingsModal').classList.remove('show');
}

async function saveAccountSettings() {
    const name = document.getElementById('settingsName').value.trim();
    let username = document.getElementById('settingsUsername').value.trim();
    const description = document.getElementById('settingsDescription').value.trim();

    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error');
        return;
    }

    if (!username) {
        showToast('–í–≤–µ–¥–∏—Ç–µ username', 'error');
        return;
    }

    if (!username.startsWith('@')) {
        username = '@' + username;
    }

    await loadAllUsers();
    const existingUser = allUsers.find(u => 
        u.username && 
        u.username.toLowerCase() === username.toLowerCase() && 
        u.user_id !== currentUser.user_id
    );
    
    if (existingUser) {
        showToast('–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π', 'error');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('users')
            .update({ name: name, username: username })
            .eq('user_id', currentUser.user_id)
            .select()
            .single();

        if (error) {
            console.error('Update error:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            return;
        }

        if (data) {
            currentUser = data;
        } else {
            currentUser.name = name;
            currentUser.username = username;
        }
        
        userDescriptions[currentUser.user_id] = description;
        localStorage.setItem('userDescriptions', JSON.stringify(userDescriptions));
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateUserDisplay();
        
        closeAccountSettings();
        showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (err) {
        console.error('Catch error:', err);
        showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
    }
}

function openThemeSettings() {
    document.getElementById('themeModal').classList.add('show');
    closeMenu();
}

function closeThemeSettings() {
    document.getElementById('themeModal').classList.remove('show');
}

function openPremiumSettings() {
    updatePremiumModal();
    document.getElementById('premiumModal').classList.add('show');
    closeMenu();
}

function closePremiumSettings() {
    document.getElementById('premiumModal').classList.remove('show');
}

function updatePremiumModal() {
    const isPremium = userPremium[currentUser.user_id] && new Date(userPremium[currentUser.user_id]) > new Date();
    
    if (isPremium) {
        document.getElementById('premiumStatusText').innerHTML = '<strong style="color: #FFD700;">–ê–ö–¢–ò–í–ï–ù</strong>';
        document.getElementById('premiumBuySection').style.display = 'none';
        document.getElementById('premiumActiveSection').style.display = 'block';
        
        const expiryDate = new Date(userPremium[currentUser.user_id]);
        document.getElementById('premiumExpiryDate').textContent = expiryDate.toLocaleDateString('ru-RU');
    } else {
        document.getElementById('premiumStatusText').innerHTML = '<strong style="color: #f44336;">–ù–ï–ê–ö–¢–ò–í–ï–ù</strong>';
        document.getElementById('premiumBuySection').style.display = 'block';
        document.getElementById('premiumActiveSection').style.display = 'none';
    }
}

async function buyPremium() {
    const currentBalance = await getCurrentShericoinBalance();
    
    if (currentBalance < 100) {
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Shericoin! –ù—É–∂–Ω–æ 100 –º–æ–Ω–µ—Ç', 'error');
        return;
    }
    
    const success = await deductShericoin(100);
    if (!success) {
        showToast('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è Shericoin', 'error');
        return;
    }
    
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 30);
    userPremium[currentUser.user_id] = expiryDate.toISOString();
    localStorage.setItem('userPremium', JSON.stringify(userPremium));
    
    showToast('–ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π!', 'success');
    updatePremiumModal();
    updateUserDisplay();
    loadChats();
}

function extendPremium() {
    buyPremium();
}

function selectProfileColor(color) {
    if (!userPremium[currentUser.user_id] || new Date(userPremium[currentUser.user_id]) <= new Date()) {
        showToast('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
        return;
    }
    
    userColors[currentUser.user_id] = color;
    localStorage.setItem('userColors', JSON.stringify(userColors));
    
    document.getElementById('menuAvatar').style.background = `linear-gradient(135deg, ${color}, ${color})`;
    
    showToast('–¶–≤–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è –∏–∑–º–µ–Ω–µ–Ω', 'success');
    loadChats();
}

function selectEmojiBackground(emoji) {
    if (!userPremium[currentUser.user_id] || new Date(userPremium[currentUser.user_id]) <= new Date()) {
        showToast('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
        return;
    }
    
    userEmojiBackgrounds[currentUser.user_id] = emoji;
    localStorage.setItem('userEmojiBackgrounds', JSON.stringify(userEmojiBackgrounds));
    
    showToast('–§–æ–Ω–æ–≤—ã–π —ç–º–æ–¥–∑–∏ –∏–∑–º–µ–Ω–µ–Ω', 'success');
}

function logout() {
    onlineStatus[currentUser.user_id] = false;
    localStorage.setItem('onlineStatus', JSON.stringify(onlineStatus));
    
    localStorage.removeItem('currentUser');
    location.reload();
}

// ============================================
// ADMIN BADGE SETTINGS
// ============================================

function openAdminBadgeSettings() {
    if (!ADMINS.includes(currentUser.username)) {
        showToast('–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
        return;
    }
    
    const modal = document.getElementById('adminBadgeModal');
    if (!modal) {
        console.error('adminBadgeModal –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        showToast('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }
    
    modal.classList.add('show');
    closeMenu();
}

function closeAdminBadgeSettings() {
    const modal = document.getElementById('adminBadgeModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

function selectAdminBadge(badge) {
    if (!ADMINS.includes(currentUser.username)) {
        showToast('–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
        return;
    }
    
    adminBadges[currentUser.username] = badge;
    localStorage.setItem('adminBadges', JSON.stringify(adminBadges));
    
    updateUserDisplay();
    
    showToast('–ó–Ω–∞—á–æ–∫ –∏–∑–º–µ–Ω—ë–Ω: ' + badge, 'success');
    closeAdminBadgeSettings();
    
    loadChats();
}

// ============================================
// CHANNELS
// ============================================

async function createSherigramChannel() {
    const { data: existing } = await supabase
        .from('channels')
        .select('*')
        .eq('username', '@sherigram')
        .single();
    
    if (existing) return;
    
    const sherigramUser = allUsers.find(u => u.username === '@sherigram');
    if (!sherigramUser) return;
    
    await supabase
        .from('channels')
        .insert([{
            channel_id: 'CH' + Date.now().toString().slice(-8),
            name: 'Sherigram Official',
            username: '@sherigram',
            description: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª Sherigram üöÄ',
            owner_id: sherigramUser.user_id,
            subscribers: []
        }]);
}

async function loadChannels() {
    const { data, error } = await supabase
        .from('channels')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (data) allChannels = data;
}

function openCreateChannelModal() {
    document.getElementById('createChannelModal').classList.add('show');
}

function closeCreateChannelModal() {
    document.getElementById('createChannelModal').classList.remove('show');
    document.getElementById('channelNameInput').value = '';
    document.getElementById('channelUsernameInput').value = '';
    document.getElementById('channelDescriptionInput').value = '';
}

async function createChannel() {
    const name = document.getElementById('channelNameInput').value.trim();
    let username = document.getElementById('channelUsernameInput').value.trim();
    const description = document.getElementById('channelDescriptionInput').value.trim();

    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞', 'error');
        return;
    }

    if (!username) {
        showToast('–í–≤–µ–¥–∏—Ç–µ username –∫–∞–Ω–∞–ª–∞', 'error');
        return;
    }

    if (!username.startsWith('@')) {
        username = '@' + username;
    }

    await loadChannels();
    const existingChannel = allChannels.find(c => c.username && c.username.toLowerCase() === username.toLowerCase());
    
    if (existingChannel) {
        showToast('–≠—Ç–æ—Ç username –∫–∞–Ω–∞–ª–∞ —É–∂–µ –∑–∞–Ω—è—Ç!', 'error');
        return;
    }

    try {
        const channelId = 'CH' + Date.now().toString().slice(-8);
        
        const { data, error } = await supabase
            .from('channels')
            .insert([{
                channel_id: channelId,
                name: name,
                username: username,
                description: description || null,
                owner_id: currentUser.user_id,
                subscribers: [currentUser.user_id]
            }])
            .select();

        if (error) {
            console.error('Channel creation error:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞', 'error');
            return;
        }

        showToast('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω!', 'success');
        closeCreateChannelModal();
        await loadChannels();
        await loadChats();
    } catch (err) {
        console.error('Catch error:', err);
        showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
    }
}

function openChannels() {
    const list = document.getElementById('channelsList');
    
    if (allChannels.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤</div>';
    } else {
        list.innerHTML = '';
        allChannels.forEach(channel => {
            const isSubscribed = channel.subscribers && channel.subscribers.includes(currentUser.user_id);
            const isOwner = channel.owner_id === currentUser.user_id;
            
            const channelDiv = document.createElement('div');
            channelDiv.style.cssText = `
                padding: 15px;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: background 0.2s, transform 0.1s;
                border-radius: 8px;
                margin-bottom: 5px;
            `;
            channelDiv.onmouseover = () => {
                channelDiv.style.background = 'var(--bg-secondary)';
            };
            channelDiv.onmouseout = () => {
                channelDiv.style.background = 'transparent';
            };
            channelDiv.onclick = () => openChannelView(channel);
            
            channelDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #F7931E); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(255,107,53,0.3);">
                        üì¢
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            ${channel.name}
                            ${isOwner ? '<span style="font-size: 14px;">üëë</span>' : ''}
                            ${isSubscribed ? '<span style="color: var(--accent-color); font-size: 18px;">‚úì</span>' : ''}
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                            ${channel.username}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            üë• ${channel.subscribers ? channel.subscribers.length : 0} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 20px;">
                        ‚Ä∫
                    </div>
                </div>
            `;
            list.appendChild(channelDiv);
        });
    }
    
    document.getElementById('channelsModal').classList.add('show');
    closeMenu();
}

function closeChannelsModal() {
    document.getElementById('channelsModal').classList.remove('show');
}

async function openChannelView(channel) {
    currentChannel = channel;
    closeChannelsModal();
    
    const isSubscribed = channel.subscribers && channel.subscribers.includes(currentUser.user_id);
    const isOwner = channel.owner_id === currentUser.user_id;
    const owner = allUsers.find(u => u.user_id === channel.owner_id);
    
    document.getElementById('channelViewName').textContent = channel.name;
    document.getElementById('channelViewUsername').textContent = channel.username;
    document.getElementById('channelViewDescription').textContent = channel.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
    document.getElementById('channelSubscribers').textContent = channel.subscribers ? channel.subscribers.length : 0;
    document.getElementById('channelOwner').textContent = owner ? owner.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    const actionBtn = document.getElementById('channelActionBtn');
    if (isOwner) {
        actionBtn.style.display = 'none';
    } else {
        actionBtn.style.display = 'block';
        actionBtn.textContent = isSubscribed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
        actionBtn.style.background = isSubscribed ? 'var(--bg-secondary)' : 'var(--accent-color)';
        actionBtn.style.color = isSubscribed ? 'var(--text-primary)' : 'white';
    }
    
    const postInput = document.getElementById('channelPostInput');
    postInput.style.display = isOwner ? 'block' : 'none';
    
    await loadChannelPosts();
    
    document.getElementById('channelViewModal').classList.add('show');
}

function closeChannelView() {
    document.getElementById('channelViewModal').classList.remove('show');
    currentChannel = null;
}

async function toggleSubscription() {
    if (!currentChannel) return;
    
    const isSubscribed = currentChannel.subscribers && currentChannel.subscribers.includes(currentUser.user_id);
    let newSubscribers = currentChannel.subscribers || [];
    
    if (isSubscribed) {
        newSubscribers = newSubscribers.filter(id => id !== currentUser.user_id);
    } else {
        newSubscribers.push(currentUser.user_id);
    }
    
    const { error } = await supabase
        .from('channels')
        .update({ subscribers: newSubscribers })
        .eq('channel_id', currentChannel.channel_id);
    
    if (error) {
        showToast('–û—à–∏–±–∫–∞', 'error');
        return;
    }
    
    currentChannel.subscribers = newSubscribers;
    showToast(isSubscribed ? '–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å' : '–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å', 'success');
    
    await loadChannels();
    await loadChats();
    const updatedChannel = allChannels.find(c => c.channel_id === currentChannel.channel_id);
    if (updatedChannel) {
        openChannelView(updatedChannel);
    }
}

async function publishPost() {
    if (!currentChannel) return;
    
    const text = document.getElementById('channelPostText').value.trim();
    if (!text) {
        showToast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'error');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('channel_posts')
            .insert([{
                channel_id: currentChannel.channel_id,
                author_id: currentUser.user_id,
                post_text: text
            }]);
        
        if (error) {
            showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error');
            return;
        }
        
        document.getElementById('channelPostText').value = '';
        showToast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!', 'success');
        await loadChannelPosts();
    } catch (err) {
        console.error('Post error:', err);
        showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
    }
}

async function loadChannelPosts() {
    if (!currentChannel) return;
    
    const { data, error } = await supabase
        .from('channel_posts')
        .select('*')
        .eq('channel_id', currentChannel.channel_id)
        .order('created_at', { ascending: false });
    
    const postsContainer = document.getElementById('channelPosts');
    
    if (!data || data.length === 0) {
        postsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div>';
        return;
    }
    
    postsContainer.innerHTML = '';
    data.forEach(post => {
        const postDiv = document.createElement('div');
        postDiv.style.cssText = 'padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; background: var(--bg-secondary);';
        
        const time = new Date(post.created_at).toLocaleString('ru-RU');
        
        postDiv.innerHTML = `
            <div style="color: var(--text-primary); margin-bottom: 8px;">${post.post_text}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${time}</div>
        `;
        postsContainer.appendChild(postDiv);
    });
}

// ============================================
// AUTO-LOGIN - –†–ê–ë–û–ß–ò–ô –í–•–û–î –ë–ï–ó –î–ï–ú–û
// ============================================

(async function() {
    const savedUser = localStorage.getItem('currentUser');
    
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('phone', userData.phone)
                .single();

            if (data && !error) {
                currentUser = data;
                await startMessenger();
            } else {
                localStorage.removeItem('currentUser');
            }
        } catch (err) {
            localStorage.removeItem('currentUser');
        }
    }
})();
</script>
</body>
</html>