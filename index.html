<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sherigram</title>
    <link rel="icon" href="./Gemini_Generated_Image_peqakfpeqakfpeqa.png" type="image/x-icon">
    <style>
        :root {
            --accent-color: #667eea;
            --accent-dark: #5568d3;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-chat: #fafafa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --online-color: #2ECC71;
            --offline-color: #9E9E9E;
        }

        body.dark {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-chat: #0e0e0e;
            --text-primary: #e0e0e0;
            --text-secondary: #999999;
            --border-color: #3d3d3d;
        }

        body.accent-blue { --accent-color: #2196F3; --accent-dark: #1976D2; }
        body.accent-green { --accent-color: #4CAF50; --accent-dark: #388E3C; }
        body.accent-grey { --accent-color: #607D8B; --accent-dark: #455A64; }
        body.accent-purple { --accent-color: #667eea; --accent-dark: #5568d3; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-dark) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            position: relative;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            body {
                background: var(--bg-primary);
            }
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
        }

        /* Auth Screen */
        .auth-screen {
            width: 100%;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-screen h1 {
            color: var(--accent-color);
            margin-bottom: 30px;
            font-size: 36px;
        }

        @media (max-width: 768px) {
            .auth-screen h1 {
                font-size: 28px;
            }
        }

        .auth-form {
            width: 100%;
            max-width: 350px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .username-input-wrapper {
            position: relative;
        }

        .username-prefix {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-weight: 600;
            font-size: 15px;
        }

        .code-inputs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .code-input {
            width: 45px;
            height: 50px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            outline: none;
        }

        @media (max-width: 768px) {
            .code-inputs {
                gap: 6px;
            }
            .code-input {
                width: 40px;
                height: 45px;
                font-size: 18px;
            }
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: var(--accent-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }

        .back-link {
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
        }

        /* Messenger */
        .messenger {
            display: none;
            width: 100%;
            position: relative;
        }

        .messenger.show {
            display: flex;
        }

        /* Sidebar Menu (–ª–µ–≤–æ–µ –º–µ–Ω—é) */
        .sidebar-menu {
            position: fixed;
            left: -280px;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-primary);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-menu.open {
            left: 0;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .menu-overlay.show {
            display: block;
        }

        .menu-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
        }

        .menu-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .menu-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
        }

        .menu-user-details h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .menu-user-details p {
            font-size: 14px;
            opacity: 0.9;
        }

        .shericoin-balance {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 20px;
            color: #333;
            font-weight: 600;
        }

        .menu-items {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
            color: var(--text-primary);
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item-icon {
            font-size: 24px;
            width: 24px;
        }

        .menu-section {
            padding: 16px 20px 8px 20px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1;
                transition: transform 0.3s;
            }
            .sidebar.mobile-hide {
                transform: translateX(-100%);
            }
        }

        .sidebar-header {
            padding: 15px 20px;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .sidebar-header h2 {
            font-size: 20px;
        }

        .search-box {
            padding: 15px;
            background: var(--bg-primary);
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .add-contact-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-primary);
        }

        .contact-item:active {
            background: var(--bg-secondary);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .contact-username {
            font-size: 13px;
            color: #667eea;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        @media (max-width: 768px) {
            .chat-area {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                z-index: 2;
                transform: translateX(100%);
                transition: transform 0.3s;
            }
            .chat-area.mobile-show {
                transform: translateX(0);
            }
        }

        .chat-header {
            padding: 15px 20px;
            /* background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color); */
            display: none;
            align-items: center;
            gap: 12px;
        }
        

        .chat-header.active {
            display: flex;
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .back-btn {
                display: block;
            }
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-info h3 {
            font-size: 16px;
            color: var(--text-primary);
        }

        .chat-header-info p {
            font-size: 13px;
            color: #667eea;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-chat);
            -webkit-overflow-scrolling: touch;
        }

        .empty-chat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        

        

       

        .chat-input {
            padding: 15px 20px;
            background: var(--bg-chat);
            /* border-top: 1px solid var(--border-color); */
            display: none;
            align-items: center;
            gap: 10px;
        }

        .chat-input.active {
            display: flex;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            font-size: 15px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
        }

        

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        /* Theme Options */
        .theme-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: var(--accent-color);
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .theme-preview.light {
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }

        .theme-preview.dark {
            background: #1e1e1e;
            color: white;
        }

        .accent-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }



        .chat-header .contact-avatar {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
        }

        .chat-header .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--online-color);
            border: 2px solid var(--bg-primary);
        }

        .chat-header .online-indicator.offline {
            background: var(--offline-color);
        }



        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .contact-item:hover {
            transform: translateX(5px);
        }

        .message {
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #chatAvatar {
            position: relative;
        }

        #chatAvatar .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border: 3px solid var(--bg-primary);
        }

        .message-menu {
            position: fixed;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 8px 0;
            z-index: 1000;
            min-width: 180px;
            display: none;
            animation: menuSlide 0.2s ease;
        }

        @keyframes menuSlide {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .message-menu.show {
            display: block;
        }

        .menu-overlay-msg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            display: none;
        }

        .menu-overlay-msg.show {
            display: block;
        }

        .message-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .message-menu-item:hover {
            background: var(--bg-secondary);
        }

        .message-menu-item.delete {
            color: #f44336;
        }

        .message-menu-icon {
            font-size: 18px;
            width: 20px;
        }

        

        .message.selected .message-content {
            background: var(--bg-secondary);
        }

        .reply-preview {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent-color);
        }

        

       
/* –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-status {
    display: inline-flex;
    align-items: center;
    margin-left: 4px;
    font-size: 11px;
    vertical-align: middle;
}

.message-status.sending {
    color: rgba(0, 0, 0, 0.4);
}

.message-status.sent {
    color: rgba(0, 0, 0, 0.4);
}

.message-status.read {
    color: var(--accent-color);
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –æ—Ç–≤–µ—Ç–∞ */
.reply-preview {
    background: rgba(102, 126, 234, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 13px;
    border-left: 3px solid var(--accent-color);
    cursor: pointer;
    transition: background 0.2s;
}

.reply-preview:hover {
    background: rgba(102, 126, 234, 0.15);
}

.reply-preview-sender {
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 3px;
    font-size: 12px;
}

.reply-preview-text {
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.message.sent .reply-preview {
    background: rgba(255, 255, 255, 0.2);
    border-left-color: rgba(255, 255, 255, 0.5);
}

.message.sent .reply-preview-sender {
    color: rgba(255, 255, 255, 0.9);
}

.message.sent .reply-preview-text {
    color: rgba(255, 255, 255, 0.7);
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ */
.reply-bar {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.reply-bar.show {
    display: flex;
}

.reply-bar-icon {
    color: var(--accent-color);
    font-size: 20px;
}

.reply-content {
    flex: 1;
    min-width: 0;
}

.reply-content-header {
    font-weight: 600;
    font-size: 13px;
    color: var(--accent-color);
    margin-bottom: 2px;
}

.reply-content-text {
    font-size: 13px;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.reply-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 5px;
    border-radius: 50%;
    transition: all 0.2s;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.reply-close:hover {
    background: var(--border-color);
    color: var(--text-primary);
}

/* –®—Ä–∏—Ñ—Ç—ã */
body.font-system {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body.font-serif {
    font-family: Georgia, 'Times New Roman', Times, serif;
}

body.font-dyslexic {
    font-family: 'Comic Sans MS', 'Trebuchet MS', Arial, sans-serif;
    letter-spacing: 0.5px;
    word-spacing: 2px;
    line-height: 1.6;
}

.font-preview {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.font-preview.serif {
    font-family: Georgia, 'Times New Roman', Times, serif;
}

.font-preview.system {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.font-preview.dyslexic {
    font-family: 'Comic Sans MS', 'Trebuchet MS', Arial, sans-serif;
}

/* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-group {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
}

.message-group.sent {
    flex-direction: row-reverse;
}

.message-group-content {
    max-width: 70%;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.message-bubble {
    padding: 10px 14px;
    border-radius: 12px;
    background: var(--border-color);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    word-wrap: break-word;
    animation: messageSlide 0.3s ease;
}

.message-group.sent .message-bubble {
    background: var(--accent-color);
    color: white;
    border-radius: 12px;
}

.message-bubble.first {
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
}

.message-bubble.last {
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
}

.message-bubble.single {
    border-radius: 18px;
}

.message-group.sent .message-bubble.first {
    border-top-right-radius: 18px;
}

.message-group.sent .message-bubble.last {
    border-bottom-right-radius: 18px;
}

.message-bubble-text {
    color: var(--text-primary);
}

.message-group.sent .message-bubble-text {
    color: white;
}



.message-bubble-reply {
    background: rgba(0, 0, 0, 0.1);
    padding: 6px 10px;
    border-radius: 8px;
    margin-bottom: 6px;
    font-size: 13px;
    border-left: 3px solid rgba(0, 0, 0, 0.2);
    cursor: pointer;
}

.message-group.sent .message-bubble-reply {
    background: rgba(255, 255, 255, 0.2);
    border-left-color: rgba(255, 255, 255, 0.5);
}

.message-bubble-reply-sender {
    font-weight: 600;
    margin-bottom: 2px;
    font-size: 12px;
}

.message-group.sent .message-status.sending {
    color: rgba(255, 255, 255, 0.6);
}

.message-group.sent .message-status.sent {
    color: rgba(255, 255, 255, 0.6);
}

.message-group.sent .message-status.read {
    color: rgba(255, 255, 255, 0.9);
}

.message-bubble-text {
    color: var(--text-primary);
    display: inline;
}

.message-group.sent .message-bubble-text {
    color: white;
}

.message-time-inline {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 11px;
    opacity: 0.6;
    margin-left: 6px;
    white-space: nowrap;
}

.message-group.sent .message-time-inline {
    opacity: 0.7;
}


        

        .accent-preview.blue { background: #2196F3; }
        .accent-preview.green { background: #4CAF50; }
        .accent-preview.grey { background: #607D8B; }
        .accent-preview.purple { background: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Screen -->
        <div class="auth-screen" id="authScreen">
            <h1>Sherigram</h1>
            <div class="auth-form">
                <div id="emailStep">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="emailInput" placeholder="your@email.com">
                    </div>
                    <button class="btn" id="sendCodeBtn">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                </div>

                <div id="codeStep" class="hidden">
                    <div class="code-inputs">
                        <input type="text" class="code-input" maxlength="1" id="code1">
                        <input type="text" class="code-input" maxlength="1" id="code2">
                        <input type="text" class="code-input" maxlength="1" id="code3">
                        <input type="text" class="code-input" maxlength="1" id="code4">
                        <input type="text" class="code-input" maxlength="1" id="code5">
                        <input type="text" class="code-input" maxlength="1" id="code6">
                    </div>
                    <button class="btn" id="verifyBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    <div class="back-link" id="backToEmail">‚Üê –ù–∞–∑–∞–¥</div>
                </div>

                <div id="profileStep" class="hidden">
                    <div class="input-group">
                        <label>–ò–º—è</label>
                        <input type="text" id="nameInput" placeholder="–ò–≤–∞–Ω">
                    </div>
                    <div class="input-group">
                        <label>Username</label>
                        <div class="username-input-wrapper">
                            <span class="username-prefix">@</span>
                            <input type="text" id="usernameInput" placeholder="ivan" style="padding-left: 28px;" minlength="5" maxlength="16">
                        </div>
                    </div>
                    <button class="btn" id="completeBtn">–ù–∞—á–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Messenger -->
        <div class="messenger" id="messenger">
            <!-- Menu Overlay -->
            <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

            <!-- Sidebar Menu -->
            <div class="sidebar-menu" id="sidebarMenu">
                <div class="menu-header">
                    <div class="menu-user-info">
                        <div class="menu-avatar" id="menuAvatar">U</div>
                        <div class="menu-user-details">
                            <h3 id="menuUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                            <p id="menuUserEmail">@user</p>
                        </div>
                    </div>

                </div>
                <div class="menu-items">
                    <div class="menu-item" onclick="openMyProfile()">
                        <span class="menu-item-icon"><img src="https://img.icons8.com/ios/30/user-male-circle--v1.png"   alt=""></span>
                        <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                    </div>
                    <div class="menu-item" onclick="openSavedMessages()">
                        <span class="menu-item-icon"><img src="https://img.icons8.com/ios/30/favorites.png" alt=""></span>
                        <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                    </div>
                    <div class="menu-section">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="menu-item" onclick="openAccountSettings()">
                        <span class="menu-item-icon"><img src="https://img.icons8.com/ios/30/edit--v1.png" alt=""></span>
                        <span>–ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
                    </div>
                    <div class="menu-item" onclick="openThemeSettings()">
                        <span class="menu-item-icon"><img src="https://img.icons8.com/ios/30/paint-palette.png" alt=""></span>
                        <span>–¢–µ–º—ã</span>
                    </div>
                    <div class="menu-item" onclick="logout()">
                        <span class="menu-item-icon"><img src="https://img.icons8.com/ios/30/export.png" alt=""></span>
                        <span>–í—ã–π—Ç–∏</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
                    <h2>Sherigram</h2>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="searchInput">
                    <button class="add-contact-btn" id="addContactBtn"><img src="https://img.icons8.com/ios/10/plus-math--v1.png" alt=""> –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="chat-header" id="chatHeader">
                    <button class="back-btn" id="backBtn">‚Üê</button>
                    <div class="contact-avatar" id="chatAvatar">U</div>
                    <div class="chat-header-info">
                        <h3 id="chatName">User</h3>
                        <p id="chatStatus">@user</p>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                </div>

                <!-- Reply Bar -->
                <!-- Reply Bar -->
<div class="reply-bar" id="replyBar">
    <span class="reply-bar-icon">‚Ü©Ô∏è</span>
    <div class="reply-content">
        <div class="reply-content-header">–û—Ç–≤–µ—Ç</div>
        <div class="reply-content-text" id="replyText">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    </div>
    <button class="reply-close" id="cancelReplyBtn">√ó</button>
</div>

                <div class="chat-input" id="chatInput">
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button class="send-btn" id="sendBtn">‚û§</button>
                </div>


                <!-- Message Menu -->


                <!-- Message Menu -->
                <div class="menu-overlay-msg" id="msgMenuOverlay"></div>
                <div class="message-menu" id="msgMenu">
                    <div class="message-menu-item" id="menuReplyBtn">
                        <span class="message-menu-icon">‚Ü©Ô∏è</span>
                        <span>–û—Ç–≤–µ—Ç–∏—Ç—å</span>
                    </div>
                    <div class="message-menu-item" id="menuCopyBtn">
                        <span class="message-menu-icon">üìã</span>
                        <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                    </div>
                    <div class="message-menu-item delete" id="menuDeleteBtn">
                        <span class="message-menu-icon">üóëÔ∏è</span>
                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Message Menu -->


    <!-- Add Contact Modal -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <div class="input-group">
                <label>Username</label>
                <div class="username-input-wrapper">
                    <span class="username-prefix">@</span>
                    <input type="text" id="addContactInput" placeholder="username" style="padding-left: 28px;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" id="closeModalBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
     <div class="modal" id="themeModal">
    <div class="modal-content">
        <h2>–¢–µ–º—ã</h2>
        
        <h3 style="margin: 20px 0 10px 0; color: var(--text-primary); font-size: 16px;">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
        <div class="theme-option" onclick="selectTheme('light')">
            <div class="theme-preview light">‚òÄÔ∏è</div>
            <div>
                <h4 style="color: var(--text-primary);">–°–≤–µ—Ç–ª–∞—è</h4>
                <p style="font-size: 13px; color: var(--text-secondary);">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</p>
            </div>
        </div>
        <div class="theme-option" onclick="selectTheme('dark')">
            <div class="theme-preview dark">üåô</div>
            <div>
                <h4 style="color: var(--text-primary);">–¢–µ–º–Ω–∞—è</h4>
                <p style="font-size: 13px; color: var(--text-secondary);">–ü—Ä–∏—è—Ç–Ω–∞—è –¥–ª—è –≥–ª–∞–∑ –≤ —Ç–µ–º–Ω–æ—Ç–µ</p>
            </div>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: var(--text-primary); font-size: 16px;">–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞</h3>
        <div class="theme-option" onclick="selectAccent('purple')">
            <div class="accent-preview purple"></div>
            <div>
                <h4 style="color: var(--text-primary);">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</h4>
            </div>
        </div>
        <div class="theme-option" onclick="selectAccent('blue')">
            <div class="accent-preview blue"></div>
            <div>
                <h4 style="color: var(--text-primary);">–°–∏–Ω–∏–π</h4>
            </div>
        </div>
        <div class="theme-option" onclick="selectAccent('green')">
            <div class="accent-preview green"></div>
            <div>
                <h4 style="color: var(--text-primary);">–ó–µ–ª–µ–Ω—ã–π</h4>
            </div>
        </div>
        <div class="theme-option" onclick="selectAccent('grey')">
            <div class="accent-preview grey"></div>
            <div>
                <h4 style="color: var(--text-primary);">–°–µ—Ä—ã–π</h4>
            </div>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: var(--text-primary); font-size: 16px;">–®—Ä–∏—Ñ—Ç</h3>
        <div class="theme-option" onclick="selectFont('system')">
            <div class="font-preview system">Aa</div>
            <div>
                <h4 style="color: var(--text-primary);">–°–∏—Å—Ç–µ–º–Ω—ã–π</h4>
                <p style="font-size: 13px; color: var(--text-secondary);">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç</p>
            </div>
        </div>
        <div class="theme-option" onclick="selectFont('serif')">
            <div class="font-preview serif">Aa</div>
            <div>
                <h4 style="color: var(--text-primary);">–û–±—ã—á–Ω—ã–π</h4>
                <p style="font-size: 13px; color: var(--text-secondary);">Georgia, Times New Roman</p>
            </div>
        </div>
        <div class="theme-option" onclick="selectFont('dyslexic')">
            <div class="font-preview dyslexic">Aa</div>
            <div>
                <h4 style="color: var(--text-primary);">Dyslexic Friendly</h4>
                <p style="font-size: 13px; color: var(--text-secondary);">–£–¥–æ–±–Ω—ã–π –¥–ª—è —á—Ç–µ–Ω–∏—è</p>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeThemeSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

     <div class="modal" id="profileModal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-color), var(--accent-dark)); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: 600;" id="profileModalAvatar">U</div>
                <h2 style="color: var(--text-primary); margin-bottom: 5px;" id="profileModalName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                <p style="color: var(--accent-color); font-size: 14px;" id="profileModalUsername">@user</p>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 5px;" id="profileModalEmail">email@example.com</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
     <div class="modal" id="savedModal">
        <div class="modal-content">
            <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
            <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 15px;">üíæ</div>
                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeSavedModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
            <div class="input-group">
                <label>–ò–º—è</label>
                <input type="text" id="editNameInput" placeholder="–ò–≤–∞–Ω">
            </div>
            <div class="input-group">
                <label>Username</label>
                <div class="username-input-wrapper">
                    <span class="username-prefix">@</span>
                    <input type="text" id="editUsernameInput" placeholder="username" style="padding-left: 28px;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAccountModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" onclick="saveAccountChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <!-- Logout Confirmation Modal -->
<div class="modal" id="logoutModal">
    <div class="modal-content">
        <h2>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?</p>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeLogoutModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn" onclick="confirmLogout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>


    <div id="toast" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent-color); color: white; padding: 12px 24px; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; z-index: 10001; font-weight: 500;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB6jdMG05myTz8qd9BIVPvsv1q6v6vDaQY",
        authDomain: "messenger-8e9c2.firebaseapp.com",
        databaseURL: "https://messenger-8e9c2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "messenger-8e9c2",
        storageBucket: "messenger-8e9c2.firebasestorage.app",
        messagingSenderId: "247357320746",
        appId: "1:247357320746:web:5c1dfc7b11d2f2e5c49d53"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    emailjs.init("zQNeeGhGe_8Tt-F3J");

    let currentUser = null;
    let currentChat = null;
    let allUsers = [];
    let verificationCode = '';
    let pendingEmail = '';
    let shericoinBalance = 0;

    // THEME MANAGEMENT
    function loadTheme() {
    const theme = localStorage.getItem('theme') || 'light';
    const accent = localStorage.getItem('accent') || 'purple';
    const font = localStorage.getItem('font') || 'system';
    
    document.body.className = `${theme} accent-${accent} font-${font}`;
}

    function selectTheme(theme) {
        localStorage.setItem('theme', theme);
        document.body.classList.remove('light', 'dark');
        document.body.classList.add(theme);
        showToast('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞');
    }

    function selectAccent(accent) {
        localStorage.setItem('accent', accent);
        document.body.classList.remove('accent-blue', 'accent-green', 'accent-grey', 'accent-purple');
        document.body.classList.add('accent-' + accent);
        showToast('–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω');
    }

    function selectFont(font) {
    localStorage.setItem('font', font);
    document.body.classList.remove('font-system', 'font-serif', 'font-dyslexic');
    document.body.classList.add('font-' + font);
    
    let fontName = '';
    switch(font) {
        case 'system':
            fontName = '–°–∏—Å—Ç–µ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç';
            break;
        case 'serif':
            fontName = '–û–±—ã—á–Ω—ã–π —à—Ä–∏—Ñ—Ç';
            break;
        case 'dyslexic':
            fontName = 'Dyslexic Friendly';
            break;
    }
    
    showToast('–®—Ä–∏—Ñ—Ç –∏–∑–º–µ–Ω–µ–Ω: ' + fontName);
}

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }

    loadTheme();

    // MENU FUNCTIONS
    function toggleMenu() {
        document.getElementById('sidebarMenu').classList.toggle('open');
        document.getElementById('menuOverlay').classList.toggle('show');
    }

    function closeMenu() {
        document.getElementById('sidebarMenu').classList.remove('open');
        document.getElementById('menuOverlay').classList.remove('show');
    }

    function openMyProfile() {
        document.getElementById('profileModalAvatar').textContent = currentUser.displayName[0].toUpperCase();
        document.getElementById('profileModalName').textContent = currentUser.displayName;
        document.getElementById('profileModalUsername').textContent = currentUser.username;
        document.getElementById('profileModalEmail').textContent = currentUser.email;
        document.getElementById('profileModal').classList.add('show');
        closeMenu();
    }

    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('show');
    }

    function openSavedMessages() {
        document.getElementById('savedModal').classList.add('show');
        closeMenu();
    }

    function closeSavedModal() {
        document.getElementById('savedModal').classList.remove('show');
    }

    function openAccountSettings() {
        document.getElementById('editNameInput').value = currentUser.displayName;
        document.getElementById('editUsernameInput').value = currentUser.username.replace('@', '');
        document.getElementById('accountModal').classList.add('show');
        closeMenu();
    }

    function closeAccountModal() {
        document.getElementById('accountModal').classList.remove('show');
    }

    async function saveAccountChanges() {
        const newName = document.getElementById('editNameInput').value.trim();
        let newUsername = document.getElementById('editUsernameInput').value.trim();
        
        if (!newName || !newUsername) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        if (!newUsername.startsWith('@')) newUsername = '@' + newUsername;

        if (newUsername !== currentUser.username) {
            const snap = await db.ref('users').orderByChild('username').equalTo(newUsername).once('value');
            if (snap.exists()) {
                showToast('–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç');
                return;
            }
        }

        await db.ref('users/' + currentUser.uid).update({ 
            displayName: newName,
            username: newUsername
        });

        currentUser.displayName = newName;
        currentUser.username = newUsername;
        saveUserToLocalStorage();
        updateUserDisplay();
        
        const contactsSnap = await db.ref('users').once('value');
        const allUsers = contactsSnap.val();
        for (let uid in allUsers) {
            if (allUsers[uid].contacts && allUsers[uid].contacts[currentUser.uid]) {
                await db.ref('users/' + uid + '/contacts/' + currentUser.uid).update({
                    displayName: newName,
                    username: newUsername
                });
            }
        }

        closeAccountModal();
        showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
    }

    function openThemeSettings() {
        document.getElementById('themeModal').classList.add('show');
        closeMenu();
    }

    function closeThemeSettings() {
        document.getElementById('themeModal').classList.remove('show');
    }

    function logout() {
    document.getElementById('logoutModal').classList.add('show');
}

function closeLogoutModal() {
    document.getElementById('logoutModal').classList.remove('show');
}

function confirmLogout() {
    localStorage.removeItem('currentUser');
    location.reload();
}

    function updateUserDisplay() {
        document.getElementById('menuAvatar').textContent = currentUser.displayName[0].toUpperCase();
        document.getElementById('menuUserName').textContent = currentUser.displayName;
        document.getElementById('menuUserEmail').textContent = currentUser.username;
    }

    // AUTH
    document.getElementById('sendCodeBtn').onclick = async () => {
        const email = document.getElementById('emailInput').value.trim();
        if (!email) return alert('–í–≤–µ–¥–∏—Ç–µ email');

        verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        pendingEmail = email;

        try {
            await emailjs.send("gmail", "template_yoqo4yr", {
                to_email: email,
                to_name: email.split('@')[0],
                app_name: "Sherigram",
                verification_code: verificationCode
            });
            console.log('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ' + verificationCode);
        } catch (e) {
            console.log('–î–µ–º–æ —Ä–µ–∂–∏–º. –ö–æ–¥: ' + verificationCode);
        }

        document.getElementById('emailStep').classList.add('hidden');
        document.getElementById('codeStep').classList.remove('hidden');
    };

    document.getElementById('backToEmail').onclick = () => {
        document.getElementById('codeStep').classList.add('hidden');
        document.getElementById('emailStep').classList.remove('hidden');
    };

    for (let i = 1; i <= 6; i++) {
        const input = document.getElementById('code' + i);
        input.oninput = (e) => {
            if (e.target.value && i < 6) document.getElementById('code' + (i + 1)).focus();
        };
    }

    document.getElementById('verifyBtn').onclick = async () => {
        const code = Array.from({length: 6}, (_, i) => document.getElementById('code' + (i + 1)).value).join('');
        
        console.log('–í–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥:', code);
        console.log('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥:', verificationCode);
        
        if (code !== verificationCode) {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: ' + verificationCode);
            return;
        }

        try {
            const snap = await db.ref('users').orderByChild('email').equalTo(pendingEmail).once('value');
            if (snap.exists()) {
                const data = snap.val();
                currentUser = { uid: Object.keys(data)[0], ...Object.values(data)[0] };
                shericoinBalance = parseInt(localStorage.getItem('shericoin_' + currentUser.uid) || '10');
                saveUserToLocalStorage();
                startMessenger();
            } else {
                document.getElementById('codeStep').classList.add('hidden');
                document.getElementById('profileStep').classList.remove('hidden');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    };

    document.getElementById('completeBtn').onclick = async () => {
        const name = document.getElementById('nameInput').value.trim();
        let username = document.getElementById('usernameInput').value.trim();
        if (!name || !username) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        if (!username.startsWith('@')) username = '@' + username;

        const newUserRef = db.ref('users').push();
        await newUserRef.set({
            email: pendingEmail,
            displayName: name,
            username: username,
            contacts: {}
        });

        currentUser = { uid: newUserRef.key, email: pendingEmail, displayName: name, username: username };
        shericoinBalance = 10;
        saveUserToLocalStorage();
        startMessenger();
    };

    // AUTO-LOGIN
    // AUTO-LOGIN
    function saveUserToLocalStorage() {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }

    function loadUserFromLocalStorage() {
        const saved = localStorage.getItem('currentUser');
        if (saved) {
            try {
                currentUser = JSON.parse(saved);
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
                localStorage.removeItem('currentUser');
                return false;
            }
        }
        return false;
    }

    if (loadUserFromLocalStorage()) {
        startMessenger();
    }

    // MESSENGER


    function startOnlineTracking() {
        const userStatusRef = db.ref('users/' + currentUser.uid + '/status');
        userStatusRef.set({ online: true, lastSeen: Date.now() });

        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val()) {
                userStatusRef.onDisconnect().set({ online: false, lastSeen: Date.now() });
                userStatusRef.set({ online: true, lastSeen: Date.now() });
            }
        });

        setInterval(() => {
            userStatusRef.update({ lastSeen: Date.now() });
        }, 30000);
    }

    function startAutoRefresh() {
        setInterval(() => {
            loadContacts();
        }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }

    async function loadContacts() {
        const snap = await db.ref('users/' + currentUser.uid + '/contacts').once('value');
        const contacts = snap.val() || {};
        const list = document.getElementById('contactsList');
        list.innerHTML = '';

        if (Object.keys(contacts).length === 0) {
            list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary)">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
            return;
        }

        for (let uid in contacts) {
            const c = contacts[uid];

            const div = document.createElement('div');
            div.className = 'contact-item';
            div.setAttribute('data-uid', uid);
            div.innerHTML = `
            <div class="contact-avatar">
                ${c.displayName[0]}
                <div class="online-indicator offline" id="indicator-${uid}"></div>
            </div>
            <div class="contact-info">
                <div class="contact-name">${c.displayName}</div>
                <div class="contact-username">${c.username}</div>
            </div>
        `;
            div.onclick = () => openChat(uid, c);
            list.appendChild(div);

            // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            db.ref('users/' + uid + '/status').on('value', (snap) => {
                const status = snap.val() || { online: false };
                const indicator = document.getElementById('indicator-' + uid);
                if (indicator) {
                    if (status.online) {
                        indicator.classList.remove('offline');
                    } else {
                        indicator.classList.add('offline');
                    }
                }
            });
        }
    }

    document.getElementById('backBtn').onclick = () => {
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞
        if (currentChat) {
            db.ref('users/' + currentChat.uid + '/status').off();
        }
        currentChat = null;

        document.getElementById('sidebar').classList.remove('mobile-hide');
        document.getElementById('chatArea').classList.remove('mobile-show');
        document.getElementById('chatHeader').classList.remove('active');
        document.getElementById('chatInput').classList.remove('active');

        // –û—á–∏—â–∞–µ–º —á–∞—Ç
        document.getElementById('chatMessages').innerHTML = '<div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>';
    };

    async function openChat(uid, contact) {
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
        if (currentChat && currentChat.uid) {
            db.ref('users/' + currentChat.uid + '/status').off();
        }

        currentChat = { uid, ...contact };
        document.getElementById('sidebar').classList.add('mobile-hide');
        document.getElementById('chatArea').classList.add('mobile-show');
        document.getElementById('chatHeader').classList.add('active');
        document.getElementById('chatInput').classList.add('active');

        // –ê–≤–∞—Ç–∞—Ä —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –æ–Ω–ª–∞–π–Ω
        const chatAvatar = document.getElementById('chatAvatar');
        chatAvatar.innerHTML = `
        ${contact.displayName[0]}
        <div class="online-indicator offline" id="chatOnlineIndicator"></div>
    `;

        document.getElementById('chatName').textContent = contact.displayName;
        document.getElementById('chatStatus').textContent = '–ø—Ä–æ–≤–µ—Ä–∫–∞...';

        // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        db.ref('users/' + uid + '/status').on('value', (snap) => {
            const status = snap.val() || { online: false, lastSeen: 0 };
            const indicator = document.getElementById('chatOnlineIndicator');
            const statusText = document.getElementById('chatStatus');

            if (status.online) {
                statusText.textContent = '–æ–Ω–ª–∞–π–Ω';
                if (indicator) indicator.classList.remove('offline');
            } else {
                if (indicator) indicator.classList.add('offline');

                if (status.lastSeen) {
                    const lastSeenDate = new Date(status.lastSeen);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastSeenDate) / 60000);

                    if (diffMinutes < 1) {
                        statusText.textContent = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                    } else if (diffMinutes < 60) {
                        statusText.textContent = `${diffMinutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
                    } else if (diffMinutes < 1440) {
                        const hours = Math.floor(diffMinutes / 60);
                        statusText.textContent = `${hours} —á. –Ω–∞–∑–∞–¥`;
                    } else {
                        statusText.textContent = lastSeenDate.toLocaleDateString('ru');
                    }
                } else {
                    statusText.textContent = contact.username;
                }
            }
        });

        loadMessages();
    }

    let selectedMessage = null;
    let replyToMessage = null;
let messagesListener = null;

async function loadMessages() {
    if (!currentChat) return;
    
    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
    if (messagesListener) {
        messagesListener.off();
    }
    
    const chatId = [currentUser.uid, currentChat.uid].sort().join('_');
    const messagesRef = db.ref('chats/' + chatId);
    
    messagesListener = messagesRef;
    
    messagesRef.on('value', (snap) => {
        const messages = snap.val();
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        
        if (!messages) {
            container.innerHTML = '<div class="empty-chat">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        const groupedMessages = groupMessages(messages);
        
        groupedMessages.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = `message-group ${group.isSent ? 'sent' : 'received'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-group-content';
            
            group.messages.forEach((msg, index) => {
                const bubbleDiv = document.createElement('div');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è —É–≥–ª–æ–≤
                let bubbleClass = 'message-bubble';
                if (group.messages.length === 1) {
                    bubbleClass += ' single';
                } else if (index === 0) {
                    bubbleClass += ' first';
                } else if (index === group.messages.length - 1) {
                    bubbleClass += ' last';
                }
                
                bubbleDiv.className = bubbleClass;
                bubbleDiv.setAttribute('data-msg-id', msg.id);
                bubbleDiv.setAttribute('data-msg-text', msg.text);
                bubbleDiv.setAttribute('data-sender-id', msg.senderId);
                
                let replyHTML = '';
                if (msg.replyTo) {
                    const replySender = msg.replyTo.senderId === currentUser.uid ? '–í—ã' : currentChat.displayName;
                    replyHTML = `
                        <div class="message-bubble-reply">
                            <div class="message-bubble-reply-sender">${replySender}</div>
                            <div class="message-bubble-reply-text">${msg.replyTo.text}</div>
                        </div>
                    `;
                }
                
                // –í—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ
                const isLastInGroup = index === group.messages.length - 1;
                const time = new Date(msg.timestamp).toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
                
                let statusIcon = '';
                if (group.isSent && isLastInGroup) {
                    if (msg.status === 'read') {
                        statusIcon = '<span class="message-status read">‚úì‚úì</span>';
                    } else if (msg.status === 'sent') {
                        statusIcon = '<span class="message-status sent">‚úì‚úì</span>';
                    } else {
                        statusIcon = '<span class="message-status sending">üïê</span>';
                    }
                }
                
                const timeHTML = isLastInGroup ? `<span class="message-time-inline">${time}${statusIcon}</span>` : '';
                
                bubbleDiv.innerHTML = `
                    ${replyHTML}
                    <div class="message-bubble-text">${msg.text} ${timeHTML}</div>
                `;
                
                bubbleDiv.onclick = (e) => {
                    e.stopPropagation();
                    showMessageMenu(e, msg.id, msg.text, msg.senderId, msg.replyTo);
                };
                
                contentDiv.appendChild(bubbleDiv);
            });
            
            groupDiv.appendChild(contentDiv);
            container.appendChild(groupDiv);
        });
        
        container.scrollTop = container.scrollHeight;
        
        // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        markMessagesAsRead(chatId);
    });
}
// –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
function groupMessages(messages) {
    const messagesArray = Object.entries(messages).map(([id, msg]) => ({
        id,
        ...msg
    })).sort((a, b) => a.timestamp - b.timestamp);
    
    const groups = [];
    let currentGroup = null;
    
    messagesArray.forEach(msg => {
        const isSent = msg.senderId === currentUser.uid;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
        if (!currentGroup || 
            currentGroup.isSent !== isSent || 
            (msg.timestamp - currentGroup.lastTimestamp) > 60000 || // 1 –º–∏–Ω—É—Ç–∞
            msg.replyTo) { // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
            
            currentGroup = {
                isSent,
                messages: [msg],
                lastTimestamp: msg.timestamp
            };
            groups.push(currentGroup);
        } else {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø–µ
            currentGroup.messages.push(msg);
            currentGroup.lastTimestamp = msg.timestamp;
        }
    });
    
    return groups;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
async function markMessagesAsRead(chatId) {
    const messagesRef = db.ref('chats/' + chatId);
    const snap = await messagesRef.once('value');
    const messages = snap.val();
    
    if (!messages) return;
    
    const updates = {};
    Object.entries(messages).forEach(([msgId, msg]) => {
        if (msg.senderId !== currentUser.uid && msg.status !== 'read') {
            updates[msgId + '/status'] = 'read';
        }
    });
    
    if (Object.keys(updates).length > 0) {
        await messagesRef.update(updates);
    }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
async function markMessagesAsRead(chatId) {
    const messagesRef = db.ref('chats/' + chatId);
    const snap = await messagesRef.once('value');
    const messages = snap.val();
    
    if (!messages) return;
    
    const updates = {};
    Object.entries(messages).forEach(([msgId, msg]) => {
        if (msg.senderId !== currentUser.uid && msg.status !== 'read') {
            updates[msgId + '/status'] = 'read';
        }
    });
    
    if (Object.keys(updates).length > 0) {
        await messagesRef.update(updates);
    }
}

    function closeMessageMenu() {
    const menu = document.getElementById('msgMenu');
    const overlay = document.getElementById('msgMenuOverlay');
    
    menu.classList.remove('show');
    overlay.classList.remove('show');
    selectedMessage = null;
    
    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    document.removeEventListener('click', handleOutsideClick);
}

   function showMessageMenu(e, msgId, msgText, senderId, replyToData) {
    e.stopPropagation();
    
    const menu = document.getElementById('msgMenu');
    const overlay = document.getElementById('msgMenuOverlay');
    
    if (menu.classList.contains('show')) {
        closeMessageMenu();
        return;
    }
    
    selectedMessage = { 
        id: msgId, 
        text: msgText, 
        senderId: senderId,
        replyTo: replyToData 
    };

    const deleteBtn = document.getElementById('menuDeleteBtn');
    if (senderId === currentUser.uid) {
        deleteBtn.style.display = 'flex';
    } else {
        deleteBtn.style.display = 'none';
    }

    const x = e.clientX;
    const y = e.clientY;

    menu.style.left = x + 'px';
    menu.style.top = y + 'px';

    setTimeout(() => {
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            menu.style.left = (x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            menu.style.top = (y - rect.height) + 'px';
        }
    }, 0);

    menu.classList.add('show');
    overlay.classList.add('show');
    
    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick, { once: false });
    }, 10);
}

function handleOutsideClick(e) {
        const menu = document.getElementById('msgMenu');
        if (menu && menu.classList.contains('show')) {
            if (!menu.contains(e.target)) {
                closeMessageMenu();
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    function initMessageMenuHandlers() {
        // Overlay
        const overlay = document.getElementById('msgMenuOverlay');
        if (overlay) {
            overlay.onclick = closeMessageMenu;
        }

        // –û—Ç–≤–µ—Ç–∏—Ç—å
        // –û—Ç–≤–µ—Ç–∏—Ç—å
const replyBtn = document.getElementById('menuReplyBtn');
if (replyBtn) {
    replyBtn.onclick = () => {
        if (selectedMessage) {
            replyToMessage = {
                text: selectedMessage.text,
                senderId: selectedMessage.senderId
            };
            
            const replyTextEl = document.getElementById('replyText');
            const replyBar = document.getElementById('replyBar');
            
            if (replyTextEl && replyBar) {
                const senderName = selectedMessage.senderId === currentUser.uid ? '–í—ã' : currentChat.displayName;
                replyTextEl.textContent = selectedMessage.text.substring(0, 50) + (selectedMessage.text.length > 50 ? '...' : '');
                replyBar.classList.add('show');
            }
            
            const msgInput = document.getElementById('messageInput');
            if (msgInput) msgInput.focus();
        }
        closeMessageMenu();
    };
}

        // –ó–∞–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');
        if (cancelReplyBtn) {
            cancelReplyBtn.onclick = () => {
                replyToMessage = null;
                const replyBar = document.getElementById('replyBar');
                if (replyBar) {
                    replyBar.classList.remove('show');
                }
            };
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        const copyBtn = document.getElementById('menuCopyBtn');
        if (copyBtn) {
            copyBtn.onclick = () => {
                if (selectedMessage) {
                    navigator.clipboard.writeText(selectedMessage.text).then(() => {
                        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
                    }).catch(() => {
                        showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                    });
                }
                closeMessageMenu();
            };
        }

        // –£–¥–∞–ª–∏—Ç—å
        const deleteBtn = document.getElementById('menuDeleteBtn');
        if (deleteBtn) {
            deleteBtn.onclick = async () => {
                if (selectedMessage && currentChat) {
                    const chatId = [currentUser.uid, currentChat.uid].sort().join('_');
                    await db.ref('chats/' + chatId + '/' + selectedMessage.id).remove();
                    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                }
                closeMessageMenu();
            };
        }

        
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay


    // –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é sendMessage
    async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !currentChat) return;

    input.value = '';

    const chatId = [currentUser.uid, currentChat.uid].sort().join('_');
    const messageData = {
        text: text,
        senderId: currentUser.uid,
        timestamp: Date.now(),
        status: 'sending'
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    if (replyToMessage) {
        messageData.replyTo = {
            text: replyToMessage.text,
            senderId: replyToMessage.senderId
        };
        replyToMessage = null;
        document.getElementById('replyBar').classList.remove('show');
    }

    const msgRef = await db.ref('chats/' + chatId).push(messageData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "sent"
    setTimeout(async () => {
        await msgRef.update({ status: 'sent' });
    }, 500);
}

    

    let searchTimeout;
    document.getElementById('searchInput').oninput = async (e) => {
        const query = e.target.value.toLowerCase().trim();

        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
        clearTimeout(searchTimeout);

        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        searchTimeout = setTimeout(async () => {
            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
            if (!query) {
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–æ–∏—Å–∫–∞
                const list = document.getElementById('contactsList');
                const items = list.querySelectorAll('.contact-item');
                items.forEach(item => {
                    const uid = item.getAttribute('data-uid');
                    if (uid) {
                        db.ref('users/' + uid + '/status').off();
                    }
                });

                loadContacts();
                return;
            }

            const snap = await db.ref('users/' + currentUser.uid + '/contacts').once('value');
            const contacts = snap.val() || {};
            const list = document.getElementById('contactsList');

            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            const oldItems = list.querySelectorAll('.contact-item');
            oldItems.forEach(item => {
                const uid = item.getAttribute('data-uid');
                if (uid) {
                    db.ref('users/' + uid + '/status').off();
                }
            });

            list.innerHTML = '';

            const filtered = Object.entries(contacts).filter(([uid, c]) =>
                c.displayName.toLowerCase().includes(query) ||
                c.username.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                for (let [uid, c] of filtered) {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.setAttribute('data-uid', uid);
                    div.innerHTML = `
                    <div class="contact-avatar">
                        ${c.displayName[0]}
                        <div class="online-indicator offline" id="search-indicator-${uid}"></div>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${c.displayName}</div>
                        <div class="contact-username">${c.username}</div>
                    </div>
                `;
                    div.onclick = () => openChat(uid, c);
                    list.appendChild(div);

                    // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    db.ref('users/' + uid + '/status').on('value', (snap) => {
                        const status = snap.val() || { online: false };
                        const indicator = document.getElementById('search-indicator-' + uid);
                        if (indicator) {
                            if (status.online) {
                                indicator.classList.remove('offline');
                            } else {
                                indicator.classList.add('offline');
                            }
                        }
                    });
                }
            }
        }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å
    };


    

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    function initMessageHandlers() {
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');

        if (sendBtn) {
            sendBtn.onclick = sendMessage;
        }

        if (messageInput) {
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') sendMessage();
            };
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
    function startMessenger() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('messenger').classList.add('show');
        updateUserDisplay();
        loadContacts();
        startOnlineTracking();
        startAutoRefresh();
        initMessageHandlers();
        initMessageMenuHandlers();
        initContactHandlers(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    }


    // ADD CONTACT - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    function initContactHandlers() {
        const addContactBtn = document.getElementById('addContactBtn');
        if (addContactBtn) {
            addContactBtn.onclick = () => {
                document.getElementById('addContactModal').classList.add('show');
            };
        }

        const closeModalBtn = document.getElementById('closeModalBtn');
        if (closeModalBtn) {
            closeModalBtn.onclick = () => {
                document.getElementById('addContactModal').classList.remove('show');
            };
        }

        const addBtn = document.getElementById('addBtn');
        if (addBtn) {
            addBtn.onclick = async () => {
                let username = document.getElementById('addContactInput').value.trim();
                if (!username) return;
                if (!username.startsWith('@')) username = '@' + username;

                const snap = await db.ref('users').orderByChild('username').equalTo(username).once('value');
                if (!snap.exists()) {
                    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const data = snap.val();
                const uid = Object.keys(data)[0];
                const user = data[uid];

                if (uid === currentUser.uid) {
                    showToast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
                    return;
                }

                await db.ref('users/' + currentUser.uid + '/contacts/' + uid).set({
                    displayName: user.displayName,
                    username: user.username
                });

                await db.ref('users/' + uid + '/contacts/' + currentUser.uid).set({
                    displayName: currentUser.displayName,
                    username: currentUser.username
                });

                document.getElementById('addContactModal').classList.remove('show');
                document.getElementById('addContactInput').value = '';
                loadContacts();
                showToast('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
            };
        }
    }

    // AUTO-LOGIN ON LOAD
    if (loadUserFromLocalStorage()) {
        startMessenger();
    }



    // ADD CONTACT
    // document.getElementById('addContactBtn').onclick = () => {
    //     document.getElementById('addContactModal').classList.add('show');
    // };

    // document.getElementById('closeModalBtn').onclick = () => {
    //     document.getElementById('addContactModal').classList.remove('show');
    // };

    // document.getElementById('addBtn').onclick = async () => {
    //     let username = document.getElementById('addContactInput').value.trim();
    //     if (!username) return;
    //     if (!username.startsWith('@')) username = '@' + username;
    //
    //     const snap = await db.ref('users').orderByChild('username').equalTo(username).once('value');
    //     if (!snap.exists()) {
    //         showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    //         return;
    //     }
    //
    //     const data = snap.val();
    //     const uid = Object.keys(data)[0];
    //     const user = data[uid];
    //
    //     if (uid === currentUser.uid) {
    //         showToast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
    //         return;
    //     }
    //
    //     await db.ref('users/' + currentUser.uid + '/contacts/' + uid).set({
    //         displayName: user.displayName,
    //         username: user.username
    //     });
    //
    //     await db.ref('users/' + uid + '/contacts/' + currentUser.uid).set({
    //         displayName: currentUser.displayName,
    //         username: currentUser.username
    //     });
    //
    //     document.getElementById('addContactModal').classList.remove('show');
    //     document.getElementById('addContactInput').value = '';
    //     loadContacts();
    //     showToast('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
    // };

    // AUTO-LOGIN ON LOAD
    // (async function() {
    //     const loggedIn = await loadUserFromLocalStorage();
    //     if (loggedIn) {
    //         startMessenger();
    //     }
    // })();
</script>
</body>
</html>
